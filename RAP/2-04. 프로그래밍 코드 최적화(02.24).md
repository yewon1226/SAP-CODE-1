## <  핵심 개념 >
- **1) CDS에서 산술 연산(계산 필드) 가능**
- **2) CDS에서 Literal(고정값) 사용 가능**
- **3) CDS에서 CAST로 타입 변환 가능**
- **4) 나누기 연산 시 CAST가 필요한 이유**
- **5) CDS CASE 구문 정리 (Simple vs Complex 분기 구조)**
- **6) CDS → OData → Gateway Client 흐름**
</br>
</br>

---

</br>

## < CDS 표현식(Expression) 기능 >
</br>

### 1) CDS에서 산술 연산(계산 필드) 가능 
- 계산은 CDS에서, 조회는 ABAP에서 수행
```abap
SELECT FROM ZS4D430_SQL_Logic
  FIELDS carrier_id,
         seats_free
  INTO TABLE @DATA(result).
```
```abap
define view entity ZS4D430_SQL_Logic
  as select from /dmo/flight
{
  key carrier_id,
  seats_max - seats_occupied as seats_free
}
```
</br>
</br>

### 2) CDS에서 Literal(고정값) 사용 가능
#### 1) ABAP SQL에서 Literal 사용
- 정수는 가능하지만, SELECT 안에서 소수점(예: 1.5) 같은 실수 Literal은 직접 사용 제한적
```abap
SELECT FROM ...
  FIELDS 'Hello' AS Character,
         1       AS Integer1,
        -1       AS Integer2
  INTO TABLE @DATA(result).
```
#### 2) ABAP CDS에서 Literal 사용
- 정수, 큰 정수, 소수점(예: 1.5)까지 다양한 타입 Literal 지원
```abap
define view entity Z_Literal_Example
  as select from ...
{
  'Hello' as Character1,   // 문자 리터럴 → CHAR 타입
  '4711'  as Character2,   // 숫자 형태 문자열 → NUMC 타입으로 인식
  1       as Integer1,     // 작은 정수 → INT1 범위
 -1       as Integer2,     // 음수 정수 → INT1 범위
  256     as Integer3,     // 더 큰 정수 → INT2 범위
  32768   as Integer4,     // 큰 정수 → INT4 범위
  1.5     as Float1        // 소수 리터럴 → FLTP(부동소수점)
}
```
</br>
</br>

### 3) CDS에서 CAST로 타입 변환 가능
- CAST는 조회 시점에만 타입을 변환하며, SELECT 결과에서만 적용되고 실행이 끝나면 DB 원본 데이터와 타입은 그대로 유지됨
- CDS는 CAST 시 기본 타입뿐 아니라 Data Element 기준으로도 변환 가능하며, 메타데이터까지 상속됨
- `preserving type` 은 Data Element의 원래 기술적 속성(길이, 도메인, 내부 타입 등)을 그대로 유지하면서, 타입 참조만 새 Data Element로 연결하는 옵션
```abap
define view entity ZS4D430_Sql02_Cast
  as select from /dmo/flight
{
  '19891109' as numc8,                       // 문자열 리터럴 → 기본 NUMC(8) 형태

  cast( '19891109' as abap.char(8) )   as char8,     // 문자형 CHAR(8)로 변환
  cast( '19891109' as abap.int4 )      as int4,      // 정수형 INT4로 변환
  cast( '19891109' as abap.dec(10,2) ) as dec10_2,   // 소수 포함 DEC(10,2)로 변환
  cast( '19891109' as abap.fltp )      as fltp,      // 부동소수점 FLTP로 변환
  cast( '19891109' as abap.dats )      as dats       // 날짜형 DATS(YYYYMMDD → 날짜)로 변환

  cast( '19891109' as /dmo/flight_date )                as fldate,    // flight_date 데이터 엘리먼트 타입 적용
  cast( '19891109' as /dmo/travel_id preserving type )  as travelid   // travel_id 타입 + DDIC 속성 유지
}
```
</br>
</br>

### 3-1) 나누기 연산 시 CAST가 필요한 이유
- 정수 ÷ 정수는 소수점이 잘려서 정확한 값이 나오지 않음 (예: 1/2 = 0)
- 그래서 퍼센트 계산 시 `cast(... as abap.fltp)` 로 먼저 실수 타입으로 바꿔줘야 함

</br>

#### 1) ABAP SQL에서 산술 연산
```abap
SELECT FROM /dmo/flight
  FIELDS
    seats_max - seats_occupied     AS seats_available,
    ( CAST( seats_occupied AS FLTP )
      * CAST( 100 AS FLTP )
    ) / CAST( seats_max AS FLTP )  AS percentage_fltp
  INTO TABLE @DATA(result).
```
#### 2) CDS에서 산술 연산
```abap
define view entity ...
  as select from /dmo/flight
{
  seats_max - seats_occupied            as seats_available,
  ( cast( seats_occupied as abap.fltp )
    * 100.0
  ) / cast( seats_max as abap.fltp )    as percentage_fltp
}
```

</br>

**- CDS / ABAP CAST 가능 타입 매핑표**

| From              | From 타입 설명                    | To                          | 비고                         |
|------------------|-----------------------------------|----------------------------|------------------------------|
| CHAR             | 일반 문자형 데이터                | CHAR, NUMC, UNIT, CUKY     | 길이가 충분해야 함           |
| NUMC             | 숫자 전용 문자형                  | CHAR, NUMC                 |                              |
| DEC, CURR, QUAN  | 소수/금액/수량 타입               | DEC, CURR, QUAN, FLTP      |                              |
| FLTP             | 부동소수점(실수) 타입             | DEC, CURR, QUAN            |                              |
| DATS, TIMS       | 날짜(YYYYMMDD) / 시간(HHMMSS)     | CHAR                       | 날짜를 문자열로 변환 시 사용 |
| INT1, INT2, INT4 | 정수 타입(1·2·4바이트 크기 구분)  | INT, DEC, FLTP             |                              |
</br>
</br>

### 4) CDS CASE 구문 정리 (Simple vs Complex 분기 구조)
- case 뒤에는 별칭을 쓸 수 없고, 반드시 실제 컬럼명(또는 표현식)만 와야 함
  
#### 1) Simple Case Distinction (단순 CASE 문)
- ABAP의 `CASE ... WHEN ... ENDCASE` 와 유사하며, 특정 값과의 `=` 비교로 결과가 결정됨
```abap
case operand
  when operand1 then result1
  when operand2 then result2
  -- ... 필요한 만큼 추가 가능
  else resultn
end as 필드명
```

#### 2) Complex Case Distinction (복잡/검색 CASE 문)
- ABAP의 `IF ... ELSEIF ... ENDIF` 와 유사하며, `AND·OR·<·>` 등 복합 조건 사용 가능
- 조건은 위에서 아래로 순차 평가되며, 먼저 참이 되는 조건이 선택됨
```abap
case 
  when sql_condition1 then result1
  when sql_condition2 then result2
  -- ... 필요한 만큼 추가 가능
  else resultn
end as 필드명
```

```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'SBOOK CDS View'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSBOOK_B03
  as select from sbook
{
  key carrid     as Carrid,
  key connid     as Connid,
  key fldate     as Fldate,
  key bookid     as Bookid,
      customid   as Customid,
      custtype   as Custtype,

      case custtype             // Simple Case
        when 'P' then 'Private Customer'
        when 'B' then 'Business Customer'
        else          ' '
      end        as Cust_Text,
      smoker     as Smoker,
      @Semantics.quantity.unitOfMeasure: 'Wunit'
      luggweight as Luggweight,

      // Complex Case
      case when luggweight < 25 then 'B'
           when luggweight >= 25 and luggweight < 40 then 'A'
           else ' '
      end        as Lugg_State,

      wunit      as Wunit,
      invoice    as Invoice,
      class      as Class,

      case class
        when 'F' then 'First'
        when 'C' then 'Business'
        when 'Y' then 'Economy'
        else '잘못된 유형의 좌석코드 입니다'
      end        as Class_Text,
      
      case when class != 'F'
        then case when wunit = 'KG' and luggweight > 20 then 'X'
                  when wunit = 'LB' and luggweight > 40 then 'X'
                  else ' '
             end
        else ' '
      end as Complex_unit,
      
      @Semantics.amount.currencyCode: 'Forcurkey'
      forcuram   as Forcuram,
      forcurkey  as Forcurkey,
      @Semantics.amount.currencyCode: 'Loccurkey'
      loccuram   as Loccuram,
      loccurkey  as Loccurkey,
}
where
  luggweight > 20
```
</br>
</br>
</br>

---

</br>

## < CDS → OData → Gateway Client 흐름 정리 >
</br>

#### 1) Gateway에서 CDS OData 서비스 실행
- `_CDS` → `@OData.publish: true` 로 CDS에서 자동 생성되는 OData 서비스
- `_SRV` → `SEGW` 에서 직접 생성하는 수동 OData 프로젝트
<img width="523" height="124" alt="image" src="https://github.com/user-attachments/assets/e7f108d9-a47d-48fc-9bdd-b8a0e278a93a" />
</br>
</br>
</br>

#### 2) CDS OData 자동 생성과 Association 확장 조회
- _CDS 서비스는 `@OData.publish: true` 를 썼기 때문에 자동 생성
- 루트 CDS에 association으로 연결된 CDS는 publish 없이도 동일한 OData 서비스에 자동 포함
- `@OData.entitySet.name` 은 Gateway에서 보이는 EntitySet 이름을 내가 직접 지정하는 애노테이션
  
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Scarr CDS View 2'
@Metadata.ignorePropagatedAnnotations: true

@OData.entitySet.name: 'Scarr'
define view entity ZCDSSCARR2_B03 as select from scarr
  association[0..*] to I_CurrencyText as _Text
    on $projection.Currcode = _Text.Currency
  association[*] to ZCDSSPFLI_B03 as _spfli 
    on scarr.carrid = _spfli.Carr_id
{
  key carrid   as Carrid,   // 주석은 이렇게
      carrname as Carrname,  // 주석 !!
      currcode as Currcode,
      
      _spfli,
      _Text
```

<img width="525" height="139" alt="image" src="https://github.com/user-attachments/assets/99f37176-18ea-4acf-9c86-0276db2b8ab5" />
</br>
</br>

- `to_` 는 OData에서 association임을 나타내는 자동 접두사

<img width="787" height="298" alt="image" src="https://github.com/user-attachments/assets/3776b53b-fd93-4738-9e05-119e81cabcdf" />
</br>
</br>

- `$expand` 는 association 데이터를 함께 가져오는 확장 조회 옵션 : `&$expand=to_Scarr`
- `$expand` 로 상위에서 확장 조회하려면 `_Scarr,` 는 반드시 선언해야 함
```abap
/sap/opu/odata/SAP/ZCDSFLIGHT2_B03_CDS/Flights?$expand=to_Scarr,to_Spfli&$format=json
```
<img width="788" height="391" alt="image" src="https://github.com/user-attachments/assets/a464e420-e583-4ebe-ac07-d97ab35e43ff" />
</br>
</br>
</br>

#### 3) CDS 2단계 경로 표현식과 OData 노출 구조
- Association이 실제로 사용되어 JOIN이 발생하면, 연결 키 필드는 반드시 projection에 있어야 함
- `_Scarr._spfli as _Spfli` 을 통해 Scarr 안의 또 다른 association(Spfli)을 OData에서 확장 조회할 수 있게 projection에 노출
- publish는 생성 조건, 서비스 등록은 실행 조건 → 둘 중 하나라도 없으면 그 CDS와 그 안의 association 모두 OData로 조회 불가

```abap
@AbapCatalog.sqlViewName: 'ZCDSFLT2_B03'
@AbapCatalog.compiler.compareFilter: true
@AbapCatalog.preserveKey: true
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Flight CDS View 2'
@Metadata.ignorePropagatedAnnotations: true

@OData.publish: true
@OData.entitySet.name: 'Flights'
define view ZCDSFLIGHT2_B03 as select from sflight
    association to ZCDSSCARR2_B03 as _Scarr
    on sflight.carrid = _Scarr.Carrid
{
    key carrid as Carrid,
    key connid as Connid,
    key fldate as Fldate,
    
    @Semantics.amount.currencyCode: 'Currency'
    @EndUserText.label: 'myPrice'
    price as Price,
    @Semantics.currencyCode: true
    currency as Currency,
    planetype as Planetype,
    seatsmax as Seatsmax,
    seatsocc as Seatsocc,
    @Semantics.amount.currencyCode: 'Currency'
    paymentsum as Paymentsum,
    
    _Scarr,
    
    // 경로표현식은 내부 조인이 일어나므로, 조인에 필요한 필드가 선언되어 있어야 함
    // 따라서 _spfli 연결 시 사용되는 _Scarr.Carrid를 별도 선언함
    _Scarr.Carrid as Carrier,
    _Scarr._spfli as _Spfli // _Scarr 안에 있는 association _spfli 호출
}
```

- 하위 뷰에 `@OData.entitySet.name` 을 명시하지 않으면, 보통 CDS 뷰의 이름이 엔티티셋 이름이 됨
<img width="535" height="196" alt="image" src="https://github.com/user-attachments/assets/e3a47b8d-77f9-4dce-a580-3224ada8efe7" />
</br>
</br>

<img width="727" height="410" alt="image" src="https://github.com/user-attachments/assets/7da39772-9e40-43da-b865-71436082bd31" />
</br>
</br>
</br>
</br>
</br>

---

</br>

## < 실습 코드 >
</br>

### 실습 1
- Association Cardinality 복습
- CDS 필터 복습

<img width="353" height="201" alt="image" src="https://github.com/user-attachments/assets/8a0e34ae-bcf7-4135-860e-44111d4e0b65" />
</br>
</br>
</br>

**1) DB Table 생성**
- ztstudent_c203
```abap
@EndUserText.label : 'ZTSTUDENT_C203'
@AbapCatalog.enhancement.category : #NOT_EXTENSIBLE
@AbapCatalog.tableCategory : #TRANSPARENT
@AbapCatalog.deliveryClass : #A
@AbapCatalog.dataMaintenance : #ALLOWED
define table ztstudent_c203 {

  key client : abap.clnt not null;
  key itemid : zdeitemidb03 not null;
  itemname   : zdeitemnameb03;
  itemtype   : zdeitemtypeb03;
  itemnum    : zdeitemnumb03;

}
```
- ztstudent_c203t
```abap
@EndUserText.label : 'Text table'
@AbapCatalog.enhancement.category : #NOT_EXTENSIBLE
@AbapCatalog.tableCategory : #TRANSPARENT
@AbapCatalog.deliveryClass : #A
@AbapCatalog.dataMaintenance : #ALLOWED
define table ztstudent_c203t {

  key client : abap.clnt not null;
  @AbapCatalog.foreignKey.screenCheck : false
  key itemid : zdeitemidb03 not null
    with foreign key ztstudent_c203
      where client = ztstudent_c203t.client
        and itemid = ztstudent_c203t.itemid;
  @AbapCatalog.foreignKey.screenCheck : false
  key langu  : langu not null
    with foreign key t002
      where spras = ztstudent_c203t.langu;
  item_text  : zdeitemtextb03;

}
```
</br>

**2) CDS 생성**
- ZCDSSTUDENT_C203
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'ZCDSSTUDENT_C203'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSSTUDENT_C203 as select from ztstudent_c203
    association [1..1] to ZCDSSTUDENT_C203T as _Student
        on $projection.Itemid = _Student.Itemid
{
    key itemid as Itemid,
    itemname as Itemname,
    itemtype as Itemtype,
    itemnum as Itemnum,
    _Student[ 1: Langu = 'E' ].ItemText as Itemtext
}
```
- ZCDSSTUDENT_C203T
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'text table'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSSTUDENT_C203T as select from ztstudent_c203t
{
    key itemid as Itemid,
    key langu as Langu,
    item_text as ItemText
}
```
</br>

**3) 결과 확인**

- 한국어버전
<img width="432" height="96" alt="image" src="https://github.com/user-attachments/assets/c8262db2-46fd-459c-8a32-9b9ca9b147ab" />

- 영어버전
<img width="433" height="95" alt="image" src="https://github.com/user-attachments/assets/9ca94da5-41b7-4efe-a653-be44a70f920c" />
</br>
</br>
</br>
</br>
</br>

### 실습 2
- cast 실습
- case when 실습
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_C_EmployeeQuery'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_C_EmployeeQuery
  as select from /LRN/R_Employee_Rel
{
  key EmployeeId,
      FirstName,
      LastName,
      DepartmentId,

      _Department.Description                  as DepartmentDescription,
      _Department._Assistant.LastName          as AssistantName,

      @EndUserText.label: 'Employee Role'
      case EmployeeId
          when _Department.HeadId then 'H'
          when _Department.AssistantId then 'A'
          else ' '
      end                                      as EmployeeRole,

      @EndUserText.label: 'Monthly Salary'
      @Semantics.amount.currencyCode: 'CurrencyCode'
      cast( AnnualSalary as abap.fltp ) / 12.0 as MonthlySalary,
      CurrencyCode,

      _Department
}
```
