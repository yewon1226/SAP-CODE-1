## <  핵심 개념 >
- **1) Annotation Propagation (필드 참조 + 애노테이션 전파)**
- **2) ABAP Dictionary에서 Foreign Key 설정 문법**
- **3) CDS Association**
- **4) Syntax Warning – Association Cardinality 불일치**
- **5) Association만 사용 vs 실제 JOIN 발생 조건**
- **6) CDS WHERE·필터·집계 함수**
- **7) ABAP SQL Association Path Expression 사용법**
</br>
</br>

---

</br>

### 1) CDS에서 산술 연산(계산 필드) 가능 
- 계산은 CDS에서, 조회는 ABAP에서 수행
```abap
SELECT FROM ZS4D430_SQL_Logic
  FIELDS carrier_id,
         seats_free
  INTO TABLE @DATA(result).
```
```abap
define view entity ZS4D430_SQL_Logic
  as select from /dmo/flight
{
  key carrier_id,

  seats_max - seats_occupied as seats_free
}
```
</br>
</br>

### 2) CDS에서 Literal(고정값) 사용 가능
#### 1) ABAP SQL에서 Literal 사용
- 정수는 가능하지만, SELECT 안에서 소수점(예: 1.5) 같은 실수 Literal은 직접 사용 제한적
```abap
SELECT FROM ...
  FIELDS 'Hello' AS Character,
         1       AS Integer1,
        -1       AS Integer2
  INTO TABLE @DATA(result).
```
#### 2) ABAP CDS에서 Literal 사용
- 정수, 큰 정수, 소수점(예: 1.5)까지 다양한 타입 Literal 지원
```abap
define view entity Z_Literal_Example
  as select from ...
{
  'Hello' as Character1,   // 문자 리터럴 → CHAR 타입
  '4711'  as Character2,   // 숫자 형태 문자열 → NUMC 타입으로 인식
  1       as Integer1,     // 작은 정수 → INT1 범위
 -1       as Integer2,     // 음수 정수 → INT1 범위
  256     as Integer3,     // 더 큰 정수 → INT2 범위
  32768   as Integer4,     // 큰 정수 → INT4 범위
  1.5     as Float1        // 소수 리터럴 → FLTP(부동소수점)
}
```
</br>
</br>

### 3) CDS에서 CAST로 타입 변환 가능
- CDS는 CAST를 이용해 조회 시점에 데이터 타입을 원하는 형식으로 변환
- CDS는 CAST 시 기본 타입뿐 아니라 Data Element 기준으로도 변환 가능하며, 메타데이터까지 상속됨
- `preserving type` 은 Data Element의 원래 기술적 속성(길이, 도메인, 내부 타입 등)을 그대로 유지하면서, 타입 참조만 새 Data Element로 연결하는 옵션
```abap
define view entity ZS4D430_Sql02_Cast
  as select from /dmo/flight
{
  '19891109' as numc8,                       // 문자열 리터럴 → 기본 NUMC(8) 형태

  cast( '19891109' as abap.char(8) )   as char8,     // 문자형 CHAR(8)로 변환
  cast( '19891109' as abap.int4 )      as int4,      // 정수형 INT4로 변환
  cast( '19891109' as abap.dec(10,2) ) as dec10_2,   // 소수 포함 DEC(10,2)로 변환
  cast( '19891109' as abap.fltp )      as fltp,      // 부동소수점 FLTP로 변환
  cast( '19891109' as abap.dats )      as dats       // 날짜형 DATS(YYYYMMDD → 날짜)로 변환

  cast( '19891109' as /dmo/flight_date )                as fldate,    // flight_date 데이터 엘리먼트 타입 적용
  cast( '19891109' as /dmo/travel_id preserving type )  as travelid   // travel_id 타입 + DDIC 속성 유지
}
```
</br>
</br>

### 3-1) 나누기 연산 시 CAST가 필요한 이유
- 정수 ÷ 정수는 소수점이 잘려서 정확한 값이 나오지 않음 (예: 1/2 = 0)
- 그래서 퍼센트 계산 시 `cast(... as abap.fltp)` 로 먼저 실수 타입으로 바꿔줘야 함

</br>

#### 1) ABAP SQL에서 산술 연산
```abap
SELECT FROM /dmo/flight
  FIELDS
    seats_max - seats_occupied     AS seats_available,
    ( CAST( seats_occupied AS FLTP )
      * CAST( 100 AS FLTP )
    ) / CAST( seats_max AS FLTP )  AS percentage_fltp
  INTO TABLE @DATA(result).
```
#### 2) CDS에서 산술 연산
```abap
define view entity ...
  as select from /dmo/flight
{
  seats_max - seats_occupied            as seats_available,
  ( cast( seats_occupied as abap.fltp )
    * 100.0
  ) / cast( seats_max as abap.fltp )    as percentage_fltp
}
```

</br>

**- CDS / ABAP CAST 가능 타입 매핑표**

| From              | From 타입 설명                    | To                          | 비고                         |
|------------------|-----------------------------------|----------------------------|------------------------------|
| CHAR             | 일반 문자형 데이터                | CHAR, NUMC, UNIT, CUKY     | 길이가 충분해야 함           |
| NUMC             | 숫자 전용 문자형                  | CHAR, NUMC                 |                              |
| DEC, CURR, QUAN  | 소수/금액/수량 타입               | DEC, CURR, QUAN, FLTP      |                              |
| FLTP             | 부동소수점(실수) 타입             | DEC, CURR, QUAN            |                              |
| DATS, TIMS       | 날짜(YYYYMMDD) / 시간(HHMMSS)     | CHAR                       | 날짜를 문자열로 변환 시 사용 |
| INT1, INT2, INT4 | 정수 타입(1·2·4바이트 크기 구분)  | INT, DEC, FLTP             |                              |
</br>
</br>

### 4) CDS CASE 구문 정리 (Simple vs Complex 분기 구조)
- case 뒤에는 별칭을 쓸 수 없고, 반드시 실제 컬럼명(또는 표현식)만 와야 함
  
#### 1) Simple Case Distinction (단순 CASE 문)
- ABAP의 `CASE ... WHEN ... ENDCASE` 와 유사하며, 특정 값과의 `=` 비교로 결과가 결정됨
```abap
case operand
  when operand1 then result1
  when operand2 then result2
  -- ... 필요한 만큼 추가 가능
  else resultn
end as 필드명
```

#### 2) Complex Case Distinction (복잡/검색 CASE 문)
- ABAP의 `IF ... ELSEIF ... ENDIF` 와 유사하며, `AND·OR·<·>` 등 복합 조건 사용 가능
- 조건은 위에서 아래로 순차 평가되며, 먼저 참이 되는 조건이 선택됨
```abap
case 
  when sql_condition1 then result1
  when sql_condition2 then result2
  -- ... 필요한 만큼 추가 가능
  else resultn
end as 필드명
```
</br>

```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'SBOOK CDS View'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSBOOK_B03
  as select from sbook
{
  key carrid     as Carrid,
  key connid     as Connid,
  key fldate     as Fldate,
  key bookid     as Bookid,
      customid   as Customid,
      custtype   as Custtype,

      case custtype             // Simple Case
        when 'P' then 'Private Customer'
        when 'B' then 'Business Customer'
        else          ' '
      end        as Cust_Text,
      smoker     as Smoker,
      @Semantics.quantity.unitOfMeasure: 'Wunit'
      luggweight as Luggweight,

      // Complex Case
      case when luggweight < 25 then 'B'
           when luggweight >= 25 and luggweight < 40 then 'A'
           else ' '
      end        as Lugg_State,

      wunit      as Wunit,
      invoice    as Invoice,
      class      as Class,

      case class
        when 'F' then 'First'
        when 'C' then 'Business'
        when 'Y' then 'Economy'
        else '잘못된 유형의 좌석코드 입니다'
      end        as Class_Text,
      
      case when class != 'F'
        then case when wunit = 'KG' and luggweight > 20 then 'X'
                  when wunit = 'LB' and luggweight > 40 then 'X'
                  else ' '
             end
        else ' '
      end as Complex_unit,
      
      @Semantics.amount.currencyCode: 'Forcurkey'
      forcuram   as Forcuram,
      forcurkey  as Forcurkey,
      @Semantics.amount.currencyCode: 'Loccurkey'
      loccuram   as Loccuram,
      loccurkey  as Loccurkey,
}
where
  luggweight > 20
```


</br>
</br>
</br>

---

</br>

## < 실습 코드 >
- Association Cardinality 복습
- CDS 필터 복습

<img width="353" height="201" alt="image" src="https://github.com/user-attachments/assets/8a0e34ae-bcf7-4135-860e-44111d4e0b65" />
</br>
</br>
</br>

**1) DB Table 생성**
- ztstudent_c203
```abap
@EndUserText.label : 'ZTSTUDENT_C203'
@AbapCatalog.enhancement.category : #NOT_EXTENSIBLE
@AbapCatalog.tableCategory : #TRANSPARENT
@AbapCatalog.deliveryClass : #A
@AbapCatalog.dataMaintenance : #ALLOWED
define table ztstudent_c203 {

  key client : abap.clnt not null;
  key itemid : zdeitemidb03 not null;
  itemname   : zdeitemnameb03;
  itemtype   : zdeitemtypeb03;
  itemnum    : zdeitemnumb03;

}
```
- ztstudent_c203t
```abap
@EndUserText.label : 'Text table'
@AbapCatalog.enhancement.category : #NOT_EXTENSIBLE
@AbapCatalog.tableCategory : #TRANSPARENT
@AbapCatalog.deliveryClass : #A
@AbapCatalog.dataMaintenance : #ALLOWED
define table ztstudent_c203t {

  key client : abap.clnt not null;
  @AbapCatalog.foreignKey.screenCheck : false
  key itemid : zdeitemidb03 not null
    with foreign key ztstudent_c203
      where client = ztstudent_c203t.client
        and itemid = ztstudent_c203t.itemid;
  @AbapCatalog.foreignKey.screenCheck : false
  key langu  : langu not null
    with foreign key t002
      where spras = ztstudent_c203t.langu;
  item_text  : zdeitemtextb03;

}
```
</br>

**2) CDS 생성**
- ZCDSSTUDENT_C203
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'ZCDSSTUDENT_C203'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSSTUDENT_C203 as select from ztstudent_c203
    association [1..1] to ZCDSSTUDENT_C203T as _Student
        on $projection.Itemid = _Student.Itemid
{
    key itemid as Itemid,
    itemname as Itemname,
    itemtype as Itemtype,
    itemnum as Itemnum,
    _Student[ 1: Langu = 'E' ].ItemText as Itemtext
}
```
- ZCDSSTUDENT_C203T
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'text table'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSSTUDENT_C203T as select from ztstudent_c203t
{
    key itemid as Itemid,
    key langu as Langu,
    item_text as ItemText
}
```
</br>

**3) 결과 확인**

- 한국어버전
<img width="432" height="96" alt="image" src="https://github.com/user-attachments/assets/c8262db2-46fd-459c-8a32-9b9ca9b147ab" />

- 영어버전
<img width="433" height="95" alt="image" src="https://github.com/user-attachments/assets/9ca94da5-41b7-4efe-a653-be44a70f920c" />
