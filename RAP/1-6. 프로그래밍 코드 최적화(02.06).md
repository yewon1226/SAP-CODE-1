## <  핵심 개념 >
- **1) ODataModel은 `getData()` / `getDate()` 같은 직접 접근 불가이고, 데이터는 `read()` 콜백이나 바인딩된 컨텍스트(`getBindingContext().getProperty()`)로만 가져올 수 있음**
- **2) `read()` 는 ODataModel만 가능, JSONModel은 `setData/getData` 로 직접 다룸**
- **3) `content aggregation` 은 하나만 가능해서 여러 컨트롤 쓰려면 `VBox` 같은 컨테이너로 감싸야 함**
- **4) `GET_ENTITY` / `GET_ENTITYSET` 은 read 호출할 때만 의미 있음**
- **5) oData FIlter 연결**
- **6) oData CRUD 구현**

</br>
</br>

---

</br>

## < Filter 연결 >
</br>

- `it_filter_select_options` → OData 필터를 필드별 SELECT-OPTIONS 구조로 파싱해서 전달하는 내부 테이블
- `iv_filter_string` → OData $filter 조건을 문자열 그대로 전달한 WHERE 절용 필터 문자열
- `WHERE (변수)` 는 문자열을 SQL 조건식으로 해석하는 ABAP의 동적 WHERE 문법

```java
// project1

onReadEntitySet: function() {
    // new Filter(path, operator, value1, value2(operator가 BT 인 경우에 씀))
    
    // let aFilter = []
    // let oFilter = new Filter("Memo", FilterOperator.Contains, "TEST2 MEMO");
    // aFilter.push(oFilter);
    let oDateFormat = sap.ui.core.format.DateFormat.getInstance({
        pattern: "yyyyMMdd",
        UTC: true
    });
    let oStartDate = oDateFormat.parse("20260119");
    let oEndDate = oDateFormat.parse("20260701");

    let oFilter = [];
    oFilter.push(new Filter("Memo", FilterOperator.Contains, "TEST2 MEMO"));
    // oFilter.push(new Filter("Role", FilterOperator.Contains, "TEST2"));
    // oFilter.push(new Filter("Projod", FilterOperator.NE, "TEST2")); // 5000번 데이터 띄우기
    oFilter.push(new Filter("Assigndate", FilterOperator.BT, oStartDate, oEndDate));

    this.oModel.read("/EmployeeSet", {
        filters: oFilter, //aFilters,
        success: function(oReturn) {
            sap.m.MessageToast.show("조회 완료, 콘솔창 확인!");
            console.log("onReadEntitySet 전체 조회 성공 : ", oReturn.results);
        }
    })
}
```
```abap
" ZCL_ZGWEMP_B03_DPC_EXT : EMPLOYEESET_GET_ENTITYSET

  method EMPLOYEESET_GET_ENTITYSET.
    DATA: lv_where_clause TYPE string.
        " 전체 필터 조건을 SQL WHERE 절 문자열로 변환
        lv_where_clause = io_tech_request_context->get_osql_where_clause( ).
        SELECT * FROM ztempinfo_b03
          INTO CORRESPONDING FIELDS OF TABLE et_entityset
          WHERE (lv_where_clause).
*    DATA: lr_memo TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_role TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_projod TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_date TYPE /IWBEP/T_COD_SELECT_OPTIONS.
*
*    IF it_filter_select_options IS INITIAL.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset.
*    ELSE.
*      " 만약 필터 정보가 들어왔다면, 필터 적용
*      LOOP AT it_filter_select_options INTO DATA(ls_filter).
*        CASE ls_filter-property.
*          WHEN 'Memo'.
*            APPEND LINES OF ls_filter-select_options TO lr_memo.
*          WHEN 'Role'.
*            APPEND LINES OF ls_filter-select_options TO lr_role.
*          WHEN 'Projod'.
*            APPEND LINES OF ls_filter-select_options TO lr_projod.
*          WHEN 'Assigndate'.
*            APPEND LINES OF ls_filter-select_options TO lr_date.
*          WHEN OTHERS.
*        ENDCASE.
*      ENDLOOP.
*
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset
*        WHERE Memo IN lr_memo
*          AND Role IN lr_role
*          AND projod IN lr_projod
*          AND assigndate IN lr_date.
*    ENDIF.
**********************************************************************
*    IF iv_filter_string IS INITIAL.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset.
*    ELSE.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset
*        WHERE (iv_filter_string).
*    ENDIF.
  endmethod.
```
</br>
</br>

---

</br>

## < sap.ui.model.odata.v2.ODataModel CRUD 메서드 정리 >
</br>

### 1) UTC 기준 Date 처리 및 DatePicker
- `UTC` → 전 세계 공통으로 사용하는 표준 시간 기준
- `UTC+9` → 한국에서 사용하는 현지 시간 기준 (UTC보다 9시간 빠름)
- UTC/UTC+9 혼용 시 날짜·시간 변환 과정에서 하루 밀림(±1일) 오류가 발생할 수 있음
</br>
</br>

- `sap.ui.core.format.DateFormat.getInstance({ pattern: "yyyyMMdd", UTC: true })` → 날짜를 UTC 기준으로 yyyyMMdd 형식 문자열로 변환하는 포맷 객체 생성
- `format()` → Date / Number 객체를 문자열로 변환하는 함수
- `parse()` → 문자열을 Date / Number 객체로 변환하는 함수
```java
let oDateFormat = sap.ui.core.format.DateFormat.getInstance({
  pattern: "yyyy-MM-dd",
  UTC: true
});

oDateFormat.format(oDate);   // Date → 문자열
oDateFormat.parse("2026-02-03"); // 문자열 → Date
```
- 서버 DateTime → 문자열로 표시
- JS Date → `sap.ui.model.type.Date`, OData DateTime 문자열 → `sap.ui.model.odata.type.DateTime`, formatter는 선택
```html
<Text text="{
  path: 'Writedate',
  type: 'sap.ui.model.odata.type.DateTime',
  formatOptions: { pattern: 'yyyy-MM-dd' }
}" />
```
</br>
</br>

- DatePicker는 화면 표시용(displayFormat)과 내부 처리용(value/valueFormat, dateValue)을 분리해 날짜 입력·처리를 안정적으로 하는 컨트롤
```html
<DatePicker
    displayFormat="yyyy-MM-dd"   <!-- 화면에 보이는 날짜 형식 -->
    valueFormat="yyyy-MM-dd"     <!-- 내부에서 문자열로 관리되는 형식 -->
    value="2026-02-03"            <!-- 문자열(String) 값 바인딩 -->
    dateValue="{/Writedate}"      <!-- Date 객체(Date) 바인딩 -->
/>
```
</br>
</br>

### 1) Read
- OData Model이 `read()` 를 호출하면 키 유무에 따라 `GET_ENTITY` 또는 `GET_ENTITYSET` 이 실행되어 DB 데이터를 조회함
- BAS 코드
```java
// test1
onReadEntitySet: function() {
    // this._oPersonModel => oData V2 Model
    let oModel = this.getView().getModel("view");

    this._oPersonModel.read("/PersonSet('9001')", {
        success: function(oReturn) {
            // Request 요청이 성공하면, succcess 함수가 실행됨
            // console.log("Read EntitySet 성공!", oReturn);
            // oModel.setProperty("/salary", oReturn.results[0].Memo);
            oModel.setProperty("/name/FirstName", oReturn.Firstname);
            oModel.setProperty("/name/LastName", oReturn.Lastname);
        }.bind(this),
        error: function(oError) {
            console.log("Read EntitySet 에러!", oError);
        }
    })
},
```
- SAP GUI 코드
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_GET_ENTITY
  method PERSONSET_GET_ENTITY.
    DATA: ls_data   TYPE zcl2person. "DB Tab 구조

    LOOP AT it_key_tab INTO DATA(ls_key).
      CASE ls_key-name.
        WHEN 'Perno'.
          ls_data-perno = ls_key-value.
      ENDCASE.
    ENDLOOP.

    SELECT SINGLE *
      FROM zcl2person
      INTO @DATA(ls_result)
      WHERE perno = @ls_data-perno.

    IF sy-subrc = 0.
      MOVE-CORRESPONDING ls_result TO er_entity.
    ENDIF.

  endmethod.
```
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_GET_ENTITYSET
  method PERSONSET_GET_ENTITYSET.
    SELECT * FROM ZCL2PERSON
      INTO TABLE ET_ENTITYSET.
  endmethod.
```
</br>
</br>

### 2) Create 
- `?` 가 들어간 파라미터는 옵셔널, 아닌 것은 필수 값
<img width="592" height="35" alt="image" src="https://github.com/user-attachments/assets/34eb1a57-53c3-4fd0-90d2-92390d1e19a5" />

</br>

- `alt` 로 선택 후에 `Ctrl + shift + 화살표 =>` 누르면 한번에 선택 가능
</br>
</br>

- 화면에서 전달한 Body 데이터를 OData가 받아 `CREATE_ENTITY` 에서 DB에 신규 데이터를 INSERT함
- BAS 코드
```java
// test1
onCreate: function() {
    let oDataModel = this.getView().getModel("view");
    let oData = oDataModel.getData();
    let oBody = {
        Perno       : oData.Perno,
        Firstname   : oData.Firstname,
        Lastname    : oData.Lastname,
        Memo        : oData.Memo
    }
    debugger;
    this._oPersonModel.create("/PersonSet", oBody, {
        success: function() {
            sap.m.MessageToast.show("성공!");
        },
        error: function(error) {
            console.log("Create EntitySet 에러!", error);
        }
    })
},
```
- SAP GUI 코드
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_CREATE_ENTITY
  method PERSONSET_CREATE_ENTITY.
    DATA: ls_entity TYPE ZCL_ZCODE_PERSON2_mpc=>ts_person,
          ls_data   TYPE zcl2person.

    io_data_provider->read_entry_data(
      IMPORTING es_data = ls_entity
    ).
    CHECK sy-subrc = 0.
    MOVE-CORRESPONDING ls_entity TO ls_data.

    INSERT zcl2person FROM ls_data.

    IF sy-subrc = 0.
      MOVE ls_entity TO er_entity.
    ENDIF.
  endmethod.
```
</br>
</br>

### 3) Update
- 키 기반 Path로 `update()` 를 호출하면 UPDATE_ENTITY에서 해당 키의 DB 데이터를 수정함
- BAS 코드
```java
// test1
onUpdate: function() {
    // 여기서 사용자 입력값에 따라 oDataModel update 로직 수행
    // 우선 사용자 입력값이 들어있는 view 모델을 가져옴
    let oModel = this.getView().getModel("view");
    let oData = oModel.getData();

    let sPath = this._oPersonModel.createKey("/PersonSet", {
        Perno : oData.Perno
    }) // 경로를 만들어줌. 예시: "/PersonSet('1000')"

    let oBody = {
        Perno       : oData.Perno,
        Firstname   : oData.Firstname,
        Lastname    : oData.Lastname,
        Memo        : oData.Memo
    }
    debugger;
    this._oPersonModel.update(sPath, oBody, {
        success: function(oReturn) {
            sap.m.MessageToast.show(oReturn);
        },
        error: function() {
            sap.m.MessageToast.show("수정 에러 발생!");
        }
    });
},
```
- SAP GUI 코드
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_UPDATE_ENTITY
  method PERSONSET_UPDATE_ENTITY.
    DATA: ls_entity TYPE ZCL_ZCODE_PERSON2_mpc=>ts_person,
          ls_data   TYPE zcl2person.

    io_data_provider->read_entry_data(
      IMPORTING es_data = ls_entity
    ).

    IF sy-subrc = 0.
      MOVE-CORRESPONDING ls_entity TO ls_data.
      UPDATE zcl2person FROM ls_data.
    ENDIF.
  endmethod.
```
</br>
</br>

### 4) Refresh
- refresh()는 서버를 다시 호출하여 `GET_ENTITYSET` 을 재실행해 최신 데이터를 다시 가져옴
- BAS 코드
```java
// test1
onRefresh: function() {
    this._oPersonModel.refresh();
}
```

</br>
</br>

### 5) Delete
- 키 기반 Path로 `remove()` 를 호출하면 DELETE_ENTITY에서 해당 키의 DB 데이터를 삭제함
- BAS 코드
```java
// test1
onDelete: function() {
    let oModel = this.getView().getModel("view");
    let oData = oModel.getData();

    let sPath = this._oPersonModel.createKey("/PersonSet", {
        Perno : oData.Perno
    }) // 경로를 만들어줌. 예시: "/PersonSet('1000')"

    this._oPersonModel.remove(sPath, {
        success: function() {
            sap.m.MessageToast.show("삭제 완료!");
        },
        error: function() {
            sap.m.MessageToast.show("삭제 에러!");
        }
    })
}
```
- SAP GUI 코드
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_DELETE_ENTITY
  method PERSONSET_DELETE_ENTITY.
    DATA: ls_data   TYPE zcl2person.

    LOOP AT it_key_tab INTO DATA(ls_key).
      CASE ls_key-name.
        WHEN 'Perno'.
          ls_data-perno = ls_key-value.
      ENDCASE.
    ENDLOOP.

    DELETE zcl2person FROM ls_data.
  endmethod.
```
</br>
</br>

---

</br>

## < 실습 코드 >
</br>

### 실습 1 : OData Filter를 이용한 EntitySet 조회 실습
- 필터 사용
<img width="599" height="281" alt="image" src="https://github.com/user-attachments/assets/bbf57f49-9fde-4002-ae11-17dfa2646b23" />

</br>
</br>

**1) SAP GUI 코드**
```abap
" ZCL_ZGWEMP_B03_DPC_EXT : EMPLOYEESET_GET_ENTITYSET
  method EMPLOYEESET_GET_ENTITYSET.
    DATA: lv_where_clause TYPE string.
        " 전체 필터 조건을 SQL WHERE 절 문자열로 변환
        lv_where_clause = io_tech_request_context->get_osql_where_clause( ).
        SELECT * FROM ztempinfo_b03
          INTO CORRESPONDING FIELDS OF TABLE et_entityset
          WHERE (lv_where_clause).
*    DATA: lr_memo TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_role TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_projod TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_date TYPE /IWBEP/T_COD_SELECT_OPTIONS.
*
*    IF it_filter_select_options IS INITIAL.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset.
*    ELSE.
*      " 만약 필터 정보가 들어왔다면, 필터 적용
*      LOOP AT it_filter_select_options INTO DATA(ls_filter).
*        CASE ls_filter-property.
*          WHEN 'Memo'.
*            APPEND LINES OF ls_filter-select_options TO lr_memo.
*          WHEN 'Role'.
*            APPEND LINES OF ls_filter-select_options TO lr_role.
*          WHEN 'Projod'.
*            APPEND LINES OF ls_filter-select_options TO lr_projod.
*          WHEN 'Assigndate'.
*            APPEND LINES OF ls_filter-select_options TO lr_date.
*          WHEN OTHERS.
*        ENDCASE.
*      ENDLOOP.
*
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset
*        WHERE Memo IN lr_memo
*          AND Role IN lr_role
*          AND projod IN lr_projod
*          AND assigndate IN lr_date.
*    ENDIF.
**********************************************************************
*    IF iv_filter_string IS INITIAL.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset.
*    ELSE.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset
*        WHERE (iv_filter_string).
*    ENDIF.
  endmethod.
```
</br>

**2) Main.controller.js**
```java
sap.ui.define([
    "sap/ui/core/mvc/Controller",
    "sap/ui/model/Filter", 
    "sap/ui/model/FilterOperator"
], (Controller, Filter, FilterOperator) => {
    "use strict";

    return Controller.extend("project1.controller.Main", {
        onInit() {
            this.oModel = this.getOwnerComponent().getModel();
        },
        onPress: function() {
            let oTable = this.getView().byId("idEmployee");
            let oItem = oTable.getSelectedItem();
            let oData = oItem.getBindingContext().getObject();
            this.oModel.read(`/EmployeeSet(Empno='${oData.Empno}',Projod='${oData.Projod}')`, {
                success: function(oReturn) {
                    sap.m.MessageBox.information(
                        `Empno:  ${oReturn.Empno}
                        Memo:  ${oReturn.Memo} 
                        Projod:  ${oReturn.Projod} 
                        Role:  ${oReturn.Role} `,
                        { title: "m.table 버튼 조회" }
                    );
                }.bind(this),
                error: function(oError) {
                    console.log("Read EntitySet 에러!", oError);
                }
            })
        },
        onSelectionChange: function(oEvent) {
            let sPath = oEvent.getParameters().listItem.getBindingContext().getPath();
            let oData = this.oModel.getProperty(sPath);
            this.oModel.read(`/EmployeeSet(Empno='${oData.Empno}',Projod='${oData.Projod}')`, {
                success: function(oReturn) {
                    sap.m.MessageBox.information(
                        `Empno:  ${oReturn.Empno}
                        Memo:  ${oReturn.Memo} 
                        Projod:  ${oReturn.Projod} 
                        Role:  ${oReturn.Role} `,
                        { title: "m.table 행 클릭 조회" }
                    );
                }.bind(this),
                error: function(oError) {
                    console.log("Read EntitySet 에러!", oError);
                }
            })
        },
        onReadEntitySet: function() {
            // new Filter(path, operator, value1, value2(operator가 BT 인 경우에 씀))
            
            // let aFilter = []
            // let oFilter = new Filter("Memo", FilterOperator.Contains, "TEST2 MEMO");
            // aFilter.push(oFilter);
            let oDateFormat = sap.ui.core.format.DateFormat.getInstance({
                pattern: "yyyyMMdd",
                UTC: true
            });
            let oStartDate = oDateFormat.parse("20260119");
            let oEndDate = oDateFormat.parse("20260701");

            let oFilter = [];
            oFilter.push(new Filter("Memo", FilterOperator.Contains, "TEST2 MEMO"));
            // oFilter.push(new Filter("Role", FilterOperator.Contains, "TEST2"));
            // oFilter.push(new Filter("Projod", FilterOperator.NE, "TEST2")); // 5000번 데이터 띄우기
            oFilter.push(new Filter("Assigndate", FilterOperator.BT, oStartDate, oEndDate));

            this.oModel.read("/EmployeeSet", {
                filters: oFilter, //aFilters,
                success: function(oReturn) {
                    sap.m.MessageToast.show("조회 완료, 콘솔창 확인!");
                    console.log("onReadEntitySet 전체 조회 성공 : ", oReturn.results);
                }
            })
        },
        onPress2: function() {
            let oTable = this.byId("idEmployee2");
            let oIndex = oTable.getSelectedIndex();

            if (oIndex < 0) return sap.m.MessageToast.show("데이터를 선택하세요.");

            let oData = oTable.getContextByIndex(oIndex).getObject();
            let sPath = `/EmployeeSet(Empno='${oData.Empno}',Projod='${oData.Projod}')`;
            // 위와 같이 전체 데이터를 가져와서, sPath 를 구성할 수도 있고,
            // this.byId("idTable").getContextByIndex(iSelectNo).getPath() 를 사용해서
            // 해당 Row의 바인딩 경로 문자열 전체를 얻을 수도 있음 
            this.oModel.read(sPath, {
                success: function(oReturn) {
                    sap.m.MessageToast.show("ui.table 버튼으로 1건 조회", oReturn);
                }.bind(this),
                error: function(oError) {
                    console.log("Read EntitySet 에러!", oError);
                }
            })
        },
        onRowSelect: function(oEvent) {
            let oRowIndex = oEvent.getParameter("rowIndex");
            let oContext = oEvent.getParameter("rowContext");
            let oData = oContext.getObject();
            this.oModel.read(`/EmployeeSet(Empno='${oData.Empno}',Projod='${oData.Projod}')`, {
                success: function(oReturn) {
                    sap.m.MessageBox.information(
                        `Empno:  ${oReturn.Empno}
                        Memo:  ${oReturn.Memo} 
                        Projod:  ${oReturn.Projod} 
                        Role:  ${oReturn.Role} `,
                        { title: "ui.table 행 클릭 조회" }
                    );
                }.bind(this),
                error: function(oError) {
                    console.log("Read EntitySet 에러!", oError);
                }
            })
        }
    });
});
```
</br>

**3) Main.view.xml**
```html
<mvc:View controllerName="project1.controller.Main"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:t="sap.ui.table"
    xmlns="sap.m">
    <Page id="page" title="{i18n>title}">
        <VBox >
            <Table id="idEmployee"
                class="sapUiSmallMarginBottom"
                inset="false"
                mode="SingleSelectLeft"
                selectionChange="onSelectionChange"
                items="{/EmployeeSet}">
                <headerToolbar>
                    <OverflowToolbar>
                        <content>
                            <Title text="Employee" level="H2"/>
                            <ToolbarSpacer />
                            <Button text="클릭" press="onPress"/>
                        </content>
                    </OverflowToolbar>
                </headerToolbar>
                <infoToolbar>
                    <OverflowToolbar>
                        <Label text="Employee"/>
                    </OverflowToolbar>
                </infoToolbar>
                <columns>
                    <Column><Text text="EMPNO" /></Column>
                    <Column><Text text="PROJOD" /></Column>
                    <Column><Text text="ASSIGNDATE" /></Column>
                    <Column><Text text="ROLE" /></Column>
                    <Column><Text text="MEMO" /></Column>
                </columns>
                <items>
                    <ColumnListItem vAlign="Middle">
                        <cells>
                            <Text text="{Empno}" />
                            <Text text="{Projod}" />
                            <Text text="{
                                path: 'Assigndate',
                                type: 'sap.ui.model.type.DateTime',
                                formatOptions: { pattern : 'yyyy-MM-dd' }
                            }" />
                            <Text text="{Role}" />
                            <Text text="{Memo}" />
                        </cells>
                    </ColumnListItem>
                </items>
            </Table>

            <t:Table rows="{/EmployeeSet}"
                    id="idEmployee2"
                    selectionMode="Single"
                    selectionBehavior="RowOnly"
                    rowSelectionChange="onRowSelect">
                <t:extension>
                    <OverflowToolbar>
                        <Title text="Employee" level="H2"/>
                        <ToolbarSpacer />
                        <Button text="EntitySet" press="onReadEntitySet"/>
                        <Button text="클릭" press="onPress2"/>
                    </OverflowToolbar>
                </t:extension>
                <t:columns>
                    <t:Column>
                        <Label text="EMPNO" />
                        <t:template>
                            <Text text="{Empno}" />
                        </t:template>
                    </t:Column>

                    <t:Column>
                        <Label text="PROJOD" />
                        <t:template>
                            <Text text="{Projod}" />
                        </t:template>
                    </t:Column>

                    <t:Column>
                        <Label text="ASSIGNDATE" />
                        <t:template>
                            <Text text="{
                                path: 'Assigndate',
                                type: 'sap.ui.model.type.DateTime',
                                formatOptions: { pattern : 'yyyy-MM-dd' }
                            }" />
                        </t:template>
                    </t:Column>

                    <t:Column>
                        <Label text="ROLE" />
                        <t:template>
                            <Text text="{Role}" />
                        </t:template>
                    </t:Column>

                    <t:Column>
                        <Label text="MEMO" />
                        <t:template>
                            <Text text="{Memo}" />
                        </t:template>
                    </t:Column>
                </t:columns>
            </t:Table>
        </VBox>
    </Page>
</mvc:View>
```
</br>
</br>
</br>

### 실습 2 : 테이블 선택 기반 CRUD 처리 실습
- CRUD 프로그램 실습
<img width="616" height="281" alt="image" src="https://github.com/user-attachments/assets/34703b4a-e106-415d-b024-21c6cd81a825" />
</br>
</br>

**1) SAP GUI 코드**
- GET_ENTITYSET
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_GET_ENTITYSET
  method PERSONSET_GET_ENTITYSET.
    SELECT * FROM ZCL2PERSON
      INTO TABLE ET_ENTITYSET.
  endmethod.
```
- GET_ENTITY
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_GET_ENTITY
  method PERSONSET_GET_ENTITY.
    DATA: ls_data   TYPE zcl2person. "DB Tab 구조

    LOOP AT it_key_tab INTO DATA(ls_key).
      CASE ls_key-name.
        WHEN 'Perno'.
          ls_data-perno = ls_key-value.
      ENDCASE.
    ENDLOOP.

    SELECT SINGLE *
      FROM zcl2person
      INTO @DATA(ls_result)
      WHERE perno = @ls_data-perno.

    IF sy-subrc = 0.
      MOVE-CORRESPONDING ls_result TO er_entity.
    ENDIF.
  endmethod.
```
- CREATE_ENTITY
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_CREATE_ENTITY
  method PERSONSET_CREATE_ENTITY.
    DATA: ls_entity TYPE ZCL_ZCODE_PERSON2_mpc=>ts_person,
          ls_data   TYPE zcl2person.

    io_data_provider->read_entry_data(
      IMPORTING es_data = ls_entity
    ).
    CHECK sy-subrc = 0.
    MOVE-CORRESPONDING ls_entity TO ls_data.

    INSERT zcl2person FROM ls_data.

    IF sy-subrc = 0.
      MOVE ls_entity TO er_entity.
    ENDIF.
  endmethod.
```
- UPDATE_ENTITY
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_UPDATE_ENTITY
  method PERSONSET_UPDATE_ENTITY.
    DATA: ls_entity TYPE ZCL_ZCODE_PERSON2_mpc=>ts_person,
          ls_data   TYPE zcl2person.

    io_data_provider->read_entry_data(
      IMPORTING es_data = ls_entity
    ).

    IF sy-subrc = 0.
      MOVE-CORRESPONDING ls_entity TO ls_data.
      UPDATE zcl2person FROM ls_data.
    ENDIF.
  endmethod.
```
- DELETE_ENTITY
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_DELETE_ENTITY
  method PERSONSET_DELETE_ENTITY.
    DATA: ls_data   TYPE zcl2person.

    LOOP AT it_key_tab INTO DATA(ls_key).
      CASE ls_key-name.
        WHEN 'Perno'.
          ls_data-perno = ls_key-value.
      ENDCASE.
    ENDLOOP.

    DELETE zcl2person FROM ls_data.
  endmethod.
```
</br>

**2) Main.controller.js**
```java
// test1
sap.ui.define([
    "sap/ui/core/mvc/Controller",
    "sap/ui/model/json/JSONModel"   // 사용할 라이브러리 추가
], (Controller, JSONModel) => {
    "use strict";

    return Controller.extend("test1.controller.Main", {
        onInit() {
            this._oPersonModel = this.getOwnerComponent().getModel("ZCODE_PERSON2_SRV");

            let oModel = this.getOwnerComponent().getModel(); // 기본 (빈문자열) 모델을 가져옴
            let oMainModel = this.getOwnerComponent().getModel("main"); // main 모델을 가져옴

            // 해당 라인에서 디버깅이 실행됨. 단, 개발자도구가 켜져있는 상태여야 함
            // debugger; 

            let oData = {
                name : { 
                    FirstName : "홍", 
                    LastName : "길동"
                 },
                age : 30,
                salary : "4000만원",
                list : [
                    { ProductNo : "P001", ProdectName : "책상", price : 10000 },
                    { ProductNo : "P002", ProdectName : "키보드", price : 5000 },
                    { ProductNo : "P003", ProdectName : "물티슈", price : 1000 },
                    { ProductNo : "P004", ProdectName : "의자", price :30000 }
                ],
                Combo : [
                    { text : "Block", key : "Block" },
                    { text : "Grid Large", key : "GridLarge" },
                    { text : "Grid Small", key : "GridSmall" }
                ]
            };
            let oJSONModel = new JSONModel(oData);
            // 모델 이름 생략 시 빈 문자열
            // 기존에 기본모델이 존재한다면 해당 모델을 덮어씀
            // 따라서 모델 이름을 부여해서 각 모델을 구분할 수 있도록 함
            // this.getView().setModel(모델객체, 모델이름); 
            this.getView().setModel(oJSONModel, "view"); 

            // 모델에 들어있는 데이터를 화면에 표시하기 위해서
            // "바인딩(Binding)" 이라는 것을 사용
            // 기본 문법
            // <tag name="{모델이름>/경로}" />  모델 이름이 있는 경우
            // <tag name="{/경로}" />           모델 이름이 없는 경우(기본)
            // 경로는 JSON 객체의 key 값으로 접근
            // => {모델이름>/key1/key2} 와 같이 하위로 내려갈 수 있음
        },
        onPress: function () {
            let oModel = this.getView().getModel("view");
            let oData = oModel.getProperty("/");            // oModel.getData();
            sap.m.MessageBox.information(
                `이름:  ${oData.name.FirstName}${oData.name.LastName} 
                나이:  ${oData.age} 
                연봉:  ${oData.salary}`
            );
        },
        onSelectionChange: function(oEvent) {
            let oModel = this.getView().getModel();
            let sPath = oEvent.getParameters().listItem.getBindingContext().getPath();
            let oData = oModel.getProperty(sPath);
            sap.m.MessageBox.information(
                `Carrid:  ${oData.Carrid} 
                Carrname:  ${oData.Carrname} 
                Currcode:  ${oData.Currcode}
                Url:  ${oData.Url}`
            );
        },
        onReadEntitySet: function() {
            // this._oPersonModel => oData V2 Model
            let oModel = this.getView().getModel("view");
    
            this._oPersonModel.read("/PersonSet('9001')", {
                success: function(oReturn) {
                    // Request 요청이 성공하면, succcess 함수가 실행됨
                    // console.log("Read EntitySet 성공!", oReturn);
                    // oModel.setProperty("/salary", oReturn.results[0].Memo);
                    oModel.setProperty("/name/FirstName", oReturn.Firstname);
                    oModel.setProperty("/name/LastName", oReturn.Lastname);
                }.bind(this),
                error: function(oError) {
                    console.log("Read EntitySet 에러!", oError);
                }
            })
        },
        onCreate: function() {
            let oDataModel = this.getView().getModel("view");
            let oData = oDataModel.getData();
            let oBody = {
                Perno       : oData.Perno,
                Firstname   : oData.Firstname,
                Lastname    : oData.Lastname,
                Memo        : oData.Memo
            }
            debugger;
            this._oPersonModel.create("/PersonSet", oBody, {
                success: function() {
                    sap.m.MessageToast.show("성공!");
                },
                error: function(error) {
                    console.log("Create EntitySet 에러!", error);
                }
            })
        },
        onSelectionChangePerson: function(oEvent) {
            let oModel = this.getView().getModel("view");   // JSONModel (이름: view) 호출
            let oParam = oEvent.getParameters();    // oEvent 객체의 파라미터들 가져오기
            if(oParam.selected) {   // 만약 row가 선택됐다면
                // 해당 Row의 바인딩 정보를 가져옴 (바인딩된 모델중, ZCODE_PERSON2_SRV 모델에 대해)
                let oData = oParam.listItem.getBindingContext("ZCODE_PERSON2_SRV").getObject();
                // view 모델에 내가 선택한 데이터를 적용
                oModel.setData(oData, true); // JSONModel (이름: view)의 필드명이 동일해서 가능한 것
            }
        },
        onUpdate: function() {
            // 여기서 사용자 입력값에 따라 oDataModel update 로직 수행
            // 우선 사용자 입력값이 들어있는 view 모델을 가져옴
            let oModel = this.getView().getModel("view");
            let oData = oModel.getData();

            let sPath = this._oPersonModel.createKey("/PersonSet", {
                Perno : oData.Perno
            }) // 경로를 만들어줌. 예시: "/PersonSet('1000')"

            let oBody = {
                Perno       : oData.Perno,
                Firstname   : oData.Firstname,
                Lastname    : oData.Lastname,
                Memo        : oData.Memo
            }
            debugger;
            this._oPersonModel.update(sPath, oBody, {
                success: function(oReturn) {
                    sap.m.MessageToast.show(oReturn);
                },
                error: function() {
                    sap.m.MessageToast.show("수정 에러 발생!");
                }
            });
        },
        onRefresh: function() {
            this._oPersonModel.refresh();
        },
        onDelete: function() {
            let oModel = this.getView().getModel("view");
            let oData = oModel.getData();

            let sPath = this._oPersonModel.createKey("/PersonSet", {
                Perno : oData.Perno
            }) // 경로를 만들어줌. 예시: "/PersonSet('1000')"

            this._oPersonModel.remove(sPath, {
                success: function() {
                    sap.m.MessageToast.show("삭제 완료!");
                },
                error: function() {
                    sap.m.MessageToast.show("삭제 에러!");
                }
            })
        }
    });
});
```
</br>

**3) Main.view.xml**
```html
// test1
<mvc:View controllerName="test1.controller.Main"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:core="sap.ui.core"
    xmlns:l = "sap.ui.layout"
    xmlns="sap.m">
    <Page id="page" title="{i18n>title}">
        <l:Grid containerQuery="true" 
                class="sapUiSmallMargin"
                defaultSpan="XL3 L4 M4 S12">
                <Input value="{view>/Perno}" description="Person No."/>
                <Input value="{view>/Firstname}" description="First Name"/>
                <Input value="{view>/Lastname}" description="Last Name"/>
                <Input value="{view>/Memo}" description="Memo"/>
        </l:Grid>

        <!-- sap.m.table 추가 -->
        <Table id="idPersonTable"
            inset="false"
            mode="SingleSelectMaster"
            selectionChange="onSelectionChangePerson"
            items="{ZCODE_PERSON2_SRV>/PersonSet}">
            <headerToolbar>
                <OverflowToolbar>
                    <content>
                        <Title text="Person" level="H2"/>
                        <Button text="EntitySet" press="onReadEntitySet" />
                        <Button text="Create" press="onCreate" />
                        <Button text="Update" press="onUpdate" />
                        <Button text="Delete" press="onDelete" />
                        <Button icon="sap-icon://refresh" press="onRefresh" />
                    </content>
                </OverflowToolbar>
            </headerToolbar>
            <infoToolbar>
                <OverflowToolbar>
                    <Label text="Person"/>
                </OverflowToolbar>
            </infoToolbar>
            <columns>
                <Column><Text text="Perno" /></Column>
                <Column><Text text="Name" /></Column>
                <Column><Text text="Memo" /></Column>
            </columns>
            <items>
                <ColumnListItem vAlign="Middle">
                    <cells>
                        <Text text="{ZCODE_PERSON2_SRV>Perno}" />
                        <ObjectIdentifier title="{ZCODE_PERSON2_SRV>Firstname}" text="{ZCODE_PERSON2_SRV>Lastname}"/>
                        <Text text="{ZCODE_PERSON2_SRV>Memo}" />
                    </cells>
                </ColumnListItem>
            </items>
        </Table>

        <Table id="idProductsTable"
            inset="false"
            mode="SingleSelectLeft"
            selectionChange="onSelectionChange"
            items="{/Carriers}">
            <headerToolbar>
                <OverflowToolbar>
                    <content>
                        <Title text="Products" level="H2"/>
                        <ToolbarSpacer />
                        <Button text="버튼" press="onPress" />
                    </content>
                </OverflowToolbar>
            </headerToolbar>
            <infoToolbar>
                <OverflowToolbar>
                    <Label text="Wide range of available products"/>
                </OverflowToolbar>
            </infoToolbar>
            <columns>
                <Column><Text text="Carrid" /></Column>
                <Column><Text text="Carrname" /></Column>
                <Column><Text text="Currcode" /></Column>
                <Column><Text text="Url" /></Column>
            </columns>
            <items>
                <ColumnListItem vAlign="Middle">
                    <cells>
                        <Text text="{Carrid}" />
                        <Text text="{Carrname}" />
                        <Text text="{Currcode}" />
                        <Text text="{Url}" />
                    </cells>
                </ColumnListItem>
            </items>
        </Table>
    </Page>
</mvc:View>
```

</br>
</br>
</br>

### 과제 1 : 테이블 선택 후 다이얼로그를 통한 데이터 수정 실습
- CRUD 프로그램 실습
<img width="739" height="300" alt="image" src="https://github.com/user-attachments/assets/b8cf4b20-472f-4401-8d48-e3133c543ddd" />

</br>
</br>

**1) SAP GUI 코드**
- UPDATE_ENTITY
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_UPDATE_ENTITY
  method PERSONSET_UPDATE_ENTITY.
    DATA: ls_entity TYPE ZCL_ZCODE_PERSON2_mpc=>ts_person,
          ls_data   TYPE zcl2person.

    io_data_provider->read_entry_data(
      IMPORTING es_data = ls_entity
    ).

    IF sy-subrc = 0.
      MOVE-CORRESPONDING ls_entity TO ls_data.
      UPDATE zcl2person FROM ls_data.
    ENDIF.
  endmethod.
```

</br>

**2) Main.controller.js**
```java
// assignment1
sap.ui.define([
    "sap/ui/core/mvc/Controller",
    "sap/ui/model/Filter",
    "sap/ui/model/FilterOperator",
     "sap/ui/model/json/JSONModel",
     "sap/ui/core/Fragment"
], (Controller, Filter, FilterOperator, JSONModel, Fragment) => {
    "use strict";

    return Controller.extend("assignment1.controller.Main", {
        onInit() {
            this.oInputModel = new JSONModel();     
            this.getView().setModel(this.oInputModel, "oInputModel");   
            this.oDataModel = this.getOwnerComponent().getModel();  
        },
        onSearch: function() {
            let oInput = this.oInputModel.getData();    // 입력값 (필터)
            let oFilter = [];
            let oDateFormat = sap.ui.core.format.DateFormat.getInstance({
                pattern: "yyyyMMdd",
                UTC: true
            });
            let oStartDate = oDateFormat.parse(oInput.Assigndate);
            let oEndDate = oDateFormat.parse("20260701");
            oFilter.push(new Filter("Assigndate", FilterOperator.BT, oStartDate, oEndDate));
            oFilter.push(new Filter("Memo", FilterOperator.EQ, oInput.Memo));

            this.byId("idEmployeeTable").getBinding("items").filter(oFilter);
        },
        onSelectionChange: function(oEvent) {
            let oData = oEvent.getParameters().listItem.getBindingContext().getObject();    // 선택한 열의 데이터 가져오기
            let oModel = new JSONModel(oData);      // 선택한 열의 데이터로 모델 생성 -> 다이얼로그에서 쓰기 위함
            let oDialog = sap.ui.getCore().byId("idDialog");    

            if(oDialog) {      
                oDialog.setModel(oModel, "oDialogModel");
                oDialog.open();
            }
            else {
                Fragment.load({
                    name: "assignment1.view.fragment.Dialog",        
                    type: "XML",        
                    controller: this    
                }).then(function(oDialog) {
                    oDialog.setModel(oModel, "oDialogModel");
                    oDialog.open();
                }.bind(this))
            }
        },
        onSave: function() {
            let oModel = sap.ui.getCore().byId("idDialog").getModel("oDialogModel");    // 다이얼로그에서 수정한 데이터 값
            let oData = oModel.getData();
            oData.Assigndate.setMinutes(
                oData.Assigndate.getMinutes() - oData.Assigndate.getTimezoneOffset()
            );

            let sPath = this.oDataModel.createKey("/EmployeeSet", {
                Empno : oData.Empno,
                Projod : oData.Projod
            })
            this.oDataModel.update(sPath, oData, {
                success: function() {
                    sap.m.MessageToast.show("수정 성공!");
                    this.oDataModel.refresh();
                }.bind(this),
                error: function() {
                    sap.m.MessageToast.show("수정 에러!");
                }
            })
        },
        onClose: function(oEvent) {
            oEvent.getSource().getParent().close();
        }
    });
});
```
</br>

**3) Main.view.xml**
```html
// assignment1
<mvc:View controllerName="assignment1.controller.Main"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:f="sap.f"
    xmlns:layout="sap.ui.layout"
    xmlns:fb="sap.ui.comp.filterbar"
    xmlns="sap.m">
    <f:DynamicPage id="dynamicPageId" headerExpanded="true" toggleHeaderOnTitleClick="false">
        <!-- DynamicPage Title -->
        <f:title>
            <f:DynamicPageTitle>
                <f:heading>
                    <Title text="Header Title"/>
                </f:heading>
                <!-- <f:content>
                    <OverflowToolbar>
                    </OverflowToolbar>
                </f:content> -->
            </f:DynamicPageTitle>
        </f:title>
        <!-- DynamicPage Header -->
        <f:header>
            <f:DynamicPageHeader pinnable="false">
                <fb:FilterBar id="filterbar" search="onSearch" persistencyKey="myPersKey" useToolbar="false" showGoOnFB="true" showFilterConfiguration="false">
                    <fb:filterGroupItems>
                        <fb:FilterGroupItem name="Assigndate" groupName="Group1" label="Assign Date" visibleInFilterBar="true">
                            <fb:control>
                                <DatePicker value="{oInputModel>/Assigndate}" />
                            </fb:control>
                        </fb:FilterGroupItem>
                        <fb:FilterGroupItem name="Memo" groupName="Group1" label="Memo" visibleInFilterBar="true">
                            <fb:control>
                                <Input value="{oInputModel>/Memo}"/>
                            </fb:control>
                        </fb:FilterGroupItem>
                        <!-- <fb:FilterGroupItem name="Search" groupName="Group1" visibleInFilterBar="true">
                            <fb:control>
                                <Button text="검색버튼" press="onPress" />
                            </fb:control>
                        </fb:FilterGroupItem> -->
                    </fb:filterGroupItems>
                </fb:FilterBar>
            </f:DynamicPageHeader>
        </f:header>
        <f:content>
            <Table id="idEmployeeTable"
                    sticky="HeaderToolbar,ColumnHeaders"
                    inset="false"
                    items="{/EmployeeSet}"
                    selectionChange="onSelectionChange"
                    class="sapFDynamicPageAlignContent"
                    mode="SingleSelectLeft"
                    width="auto">
                <headerToolbar>
                    <Toolbar>
                        <Title text="Products" level="H2"/>
                    </Toolbar>
                </headerToolbar>
                <columns>
                    <Column width="12em">
                        <Text text="Empno" />
                    </Column>
                    <Column width="12em">
                        <Text text="Projod" />
                    </Column>
                    <Column width="12em">
                        <Text text="Assigndate" />
                    </Column>
                    <Column width="12em">
                        <Text text="Role" />
                    </Column>
                    <Column width="12em">
                        <Text text="Memo" />
                    </Column>
                </columns>
                <items>
                    <ColumnListItem>
                        <cells>
                            <Text text="{Empno}" />
                            <Text text="{Projod}" />
                            <Text text="{
                                path: 'Assigndate',
                                type: 'sap.ui.model.type.DateTime',
                                formatOptions: { pattern : 'yyyy-MM-dd' }
                            }" />
                            <Text text="{Role}" />
                            <Text text="{Memo}" />
                        </cells>
                    </ColumnListItem>
                </items>
            </Table>
        </f:content>
    </f:DynamicPage>
</mvc:View>
```
</br>

**4) Dialog.fragment.xml**
```html
// assignment1
<c:FragmentDefinition 
    xmlns="sap.m" 
    xmlns:f="sap.ui.layout.form"
    xmlns:c="sap.ui.core">
    <Dialog id="idDialog"
            title="Select List"
            contentHeight="40%"
            contentWidth="20%">
        <content>
            <f:SimpleForm
                layout="ColumnLayout"
                columnsXL="1"
                columnsL="1"
                columnsM="1">
                <f:content>
                    <Label text="Empno"/>
                    <Input value="{oDialogModel>/Empno}" />
                    <Label text="Projod"/>
                    <Input value="{oDialogModel>/Projod}" />
                    <Label text="Assign date"/>
                    <DatePicker
                        dateValue="{oDialogModel>/Assigndate}"
                        displayFormat="yyyy-MM-dd"
                    />
                    <Label text="Role"/>
                    <Input value="{oDialogModel>/Role}" />
                    <Label text="Memo"/>
                    <Input value="{oDialogModel>/Memo}" />
                </f:content>
            </f:SimpleForm>
        </content>
        <buttons>
            <Button text="저장" press=".onSave" />
            <Button text="닫기" press=".onClose" />
        </buttons>
    </Dialog>
</c:FragmentDefinition>
```
