## <  핵심 개념 >
- **1) ODataModel은 `getData()` / `getDate()` 같은 직접 접근 불가이고, 데이터는 `read()` 콜백이나 바인딩된 컨텍스트(`getBindingContext().getProperty()`)로만 가져올 수 있음**
- **2) `read()` 는 ODataModel만 가능, JSONModel은 `setData/getData` 로 직접 다룸**
- **3) `content aggregation` 은 하나만 가능해서 여러 컨트롤 쓰려면 `VBox` 같은 컨테이너로 감싸야 함**
- **4) `GET_ENTITY` / `GET_ENTITYSET` 은 read 호출할 때만 의미 있음**

</br>
</br>

---

</br>

## < Filter 연결 >
</br>

- `it_filter_select_options` → OData 필터를 필드별 SELECT-OPTIONS 구조로 파싱해서 전달하는 내부 테이블
- `iv_filter_string` → OData $filter 조건을 문자열 그대로 전달한 WHERE 절용 필터 문자열
- `WHERE (변수)` 는 문자열을 SQL 조건식으로 해석하는 ABAP의 동적 WHERE 문법

```java
// project1

onReadEntitySet: function() {
    // new Filter(path, operator, value1, value2(operator가 BT 인 경우에 씀))
    
    // let aFilter = []
    // let oFilter = new Filter("Memo", FilterOperator.Contains, "TEST2 MEMO");
    // aFilter.push(oFilter);
    let oDateFormat = sap.ui.core.format.DateFormat.getInstance({
        pattern: "yyyyMMdd",
        UTC: true
    });
    let oStartDate = oDateFormat.parse("20260119");
    let oEndDate = oDateFormat.parse("20260701");

    let oFilter = [];
    oFilter.push(new Filter("Memo", FilterOperator.Contains, "TEST2 MEMO"));
    // oFilter.push(new Filter("Role", FilterOperator.Contains, "TEST2"));
    // oFilter.push(new Filter("Projod", FilterOperator.NE, "TEST2")); // 5000번 데이터 띄우기
    oFilter.push(new Filter("Assigndate", FilterOperator.BT, oStartDate, oEndDate));

    this.oModel.read("/EmployeeSet", {
        filters: oFilter, //aFilters,
        success: function(oReturn) {
            sap.m.MessageToast.show("조회 완료, 콘솔창 확인!");
            console.log("onReadEntitySet 전체 조회 성공 : ", oReturn.results);
        }
    })
}
```
```abap
" ZCL_ZGWEMP_B03_DPC_EXT : EMPLOYEESET_GET_ENTITYSET

  method EMPLOYEESET_GET_ENTITYSET.
    DATA: lv_where_clause TYPE string.
        " 전체 필터 조건을 SQL WHERE 절 문자열로 변환
        lv_where_clause = io_tech_request_context->get_osql_where_clause( ).
        SELECT * FROM ztempinfo_b03
          INTO CORRESPONDING FIELDS OF TABLE et_entityset
          WHERE (lv_where_clause).
*    DATA: lr_memo TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_role TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_projod TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_date TYPE /IWBEP/T_COD_SELECT_OPTIONS.
*
*    IF it_filter_select_options IS INITIAL.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset.
*    ELSE.
*      " 만약 필터 정보가 들어왔다면, 필터 적용
*      LOOP AT it_filter_select_options INTO DATA(ls_filter).
*        CASE ls_filter-property.
*          WHEN 'Memo'.
*            APPEND LINES OF ls_filter-select_options TO lr_memo.
*          WHEN 'Role'.
*            APPEND LINES OF ls_filter-select_options TO lr_role.
*          WHEN 'Projod'.
*            APPEND LINES OF ls_filter-select_options TO lr_projod.
*          WHEN 'Assigndate'.
*            APPEND LINES OF ls_filter-select_options TO lr_date.
*          WHEN OTHERS.
*        ENDCASE.
*      ENDLOOP.
*
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset
*        WHERE Memo IN lr_memo
*          AND Role IN lr_role
*          AND projod IN lr_projod
*          AND assigndate IN lr_date.
*    ENDIF.
**********************************************************************
*    IF iv_filter_string IS INITIAL.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset.
*    ELSE.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset
*        WHERE (iv_filter_string).
*    ENDIF.
  endmethod.
```
</br>
</br>

---

</br>

## < sap.ui.model.odata.v2.ODataModel CRUD 메서드 정리 >
</br>

### 1) UTC 기준 Date 처리 및 DatePicker
- `UTC` → 전 세계 공통으로 사용하는 표준 시간 기준
- `UTC+9` → 한국에서 사용하는 현지 시간 기준 (UTC보다 9시간 빠름)
- UTC/UTC+9 혼용 시 날짜·시간 변환 과정에서 하루 밀림(±1일) 오류가 발생할 수 있음
</br>
</br>

- `sap.ui.core.format.DateFormat.getInstance({ pattern: "yyyyMMdd", UTC: true })` → 날짜를 UTC 기준으로 yyyyMMdd 형식 문자열로 변환하는 포맷 객체 생성
- `format()` → Date / Number 객체를 문자열로 변환하는 함수
- `parse()` → 문자열을 Date / Number 객체로 변환하는 함수
```java
let oDateFormat = sap.ui.core.format.DateFormat.getInstance({
  pattern: "yyyy-MM-dd",
  UTC: true
});

oDateFormat.format(oDate);   // Date → 문자열
oDateFormat.parse("2026-02-03"); // 문자열 → Date
```
- 서버 DateTime → 문자열로 표시
- JS Date → `sap.ui.model.type.Date`, OData DateTime 문자열 → `sap.ui.model.odata.type.DateTime`, formatter는 선택
```html
<Text text="{
  path: 'Writedate',
  type: 'sap.ui.model.odata.type.DateTime',
  formatOptions: { pattern: 'yyyy-MM-dd' }
}" />
```
</br>
</br>

- DatePicker는 화면 표시용(displayFormat)과 내부 처리용(value/valueFormat, dateValue)을 분리해 날짜 입력·처리를 안정적으로 하는 컨트롤
```html
<DatePicker
    displayFormat="yyyy-MM-dd"   <!-- 화면에 보이는 날짜 형식 -->
    valueFormat="yyyy-MM-dd"     <!-- 내부에서 문자열로 관리되는 형식 -->
    value="2026-02-03"            <!-- 문자열(String) 값 바인딩 -->
    dateValue="{/Writedate}"      <!-- Date 객체(Date) 바인딩 -->
/>
```
</br>
</br>

### 1) Read
- OData Model이 `read()` 를 호출하면 키 유무에 따라 `GET_ENTITY` 또는 `GET_ENTITYSET` 이 실행되어 DB 데이터를 조회함
- BAS 코드
```java
// test1
onReadEntitySet: function() {
    // this._oPersonModel => oData V2 Model
    let oModel = this.getView().getModel("view");

    this._oPersonModel.read("/PersonSet('9001')", {
        success: function(oReturn) {
            // Request 요청이 성공하면, succcess 함수가 실행됨
            // console.log("Read EntitySet 성공!", oReturn);
            // oModel.setProperty("/salary", oReturn.results[0].Memo);
            oModel.setProperty("/name/FirstName", oReturn.Firstname);
            oModel.setProperty("/name/LastName", oReturn.Lastname);
        }.bind(this),
        error: function(oError) {
            console.log("Read EntitySet 에러!", oError);
        }
    })
},
```
- SAP GUI 코드
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_GET_ENTITY
  method PERSONSET_GET_ENTITY.
    DATA: ls_data   TYPE zcl2person. "DB Tab 구조

    LOOP AT it_key_tab INTO DATA(ls_key).
      CASE ls_key-name.
        WHEN 'Perno'.
          ls_data-perno = ls_key-value.
      ENDCASE.
    ENDLOOP.

    SELECT SINGLE *
      FROM zcl2person
      INTO @DATA(ls_result)
      WHERE perno = @ls_data-perno.

    IF sy-subrc = 0.
      MOVE-CORRESPONDING ls_result TO er_entity.
    ENDIF.

  endmethod.
```
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_GET_ENTITYSET
  method PERSONSET_GET_ENTITYSET.
    SELECT * FROM ZCL2PERSON
      INTO TABLE ET_ENTITYSET.
  endmethod.
```
</br>
</br>

### 2) Create 
- `?` 가 들어간 파라미터는 옵셔널, 아닌 것은 필수 값
<img width="592" height="35" alt="image" src="https://github.com/user-attachments/assets/34eb1a57-53c3-4fd0-90d2-92390d1e19a5" />

</br>

- `alt` 로 선택 후에 `Ctrl + shift + 화살표 =>` 누르면 한번에 선택 가능
</br>
</br>

- 화면에서 전달한 Body 데이터를 OData가 받아 `CREATE_ENTITY` 에서 DB에 신규 데이터를 INSERT함
- BAS 코드
```java
// test1
onCreate: function() {
    let oDataModel = this.getView().getModel("view");
    let oData = oDataModel.getData();
    let oBody = {
        Perno       : oData.Perno,
        Firstname   : oData.Firstname,
        Lastname    : oData.Lastname,
        Memo        : oData.Memo
    }
    debugger;
    this._oPersonModel.create("/PersonSet", oBody, {
        success: function() {
            sap.m.MessageToast.show("성공!");
        },
        error: function(error) {
            console.log("Create EntitySet 에러!", error);
        }
    })
},
```
- SAP GUI 코드
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_CREATE_ENTITY
  method PERSONSET_CREATE_ENTITY.
    DATA: ls_entity TYPE ZCL_ZCODE_PERSON2_mpc=>ts_person,
          ls_data   TYPE zcl2person.

    io_data_provider->read_entry_data(
      IMPORTING es_data = ls_entity
    ).
    CHECK sy-subrc = 0.
    MOVE-CORRESPONDING ls_entity TO ls_data.

    INSERT zcl2person FROM ls_data.

    IF sy-subrc = 0.
      MOVE ls_entity TO er_entity.
    ENDIF.
  endmethod.
```
</br>
</br>

### 3) Update
- 키 기반 Path로 `update()` 를 호출하면 UPDATE_ENTITY에서 해당 키의 DB 데이터를 수정함
- BAS 코드
```java
// test1
onUpdate: function() {
    // 여기서 사용자 입력값에 따라 oDataModel update 로직 수행
    // 우선 사용자 입력값이 들어있는 view 모델을 가져옴
    let oModel = this.getView().getModel("view");
    let oData = oModel.getData();

    let sPath = this._oPersonModel.createKey("/PersonSet", {
        Perno : oData.Perno
    }) // 경로를 만들어줌. 예시: "/PersonSet('1000')"

    let oBody = {
        Perno       : oData.Perno,
        Firstname   : oData.Firstname,
        Lastname    : oData.Lastname,
        Memo        : oData.Memo
    }
    debugger;
    this._oPersonModel.update(sPath, oBody, {
        success: function(oReturn) {
            sap.m.MessageToast.show(oReturn);
        },
        error: function() {
            sap.m.MessageToast.show("수정 에러 발생!");
        }
    });
},
```
- SAP GUI 코드
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_UPDATE_ENTITY
  method PERSONSET_UPDATE_ENTITY.
    DATA: ls_entity TYPE ZCL_ZCODE_PERSON2_mpc=>ts_person,
          ls_data   TYPE zcl2person.

    io_data_provider->read_entry_data(
      IMPORTING es_data = ls_entity
    ).

    IF sy-subrc = 0.
      MOVE-CORRESPONDING ls_entity TO ls_data.
      UPDATE zcl2person FROM ls_data.
    ENDIF.
  endmethod.
```
</br>
</br>

### 4) Refresh
- refresh()는 서버를 다시 호출하여 `GET_ENTITYSET` 을 재실행해 최신 데이터를 다시 가져옴
- BAS 코드
```java
// test1
onRefresh: function() {
    this._oPersonModel.refresh();
}
```

</br>
</br>

### 5) Delete
- 키 기반 Path로 `remove()` 를 호출하면 DELETE_ENTITY에서 해당 키의 DB 데이터를 삭제함
- BAS 코드
```java
// test1
onDelete: function() {
    let oModel = this.getView().getModel("view");
    let oData = oModel.getData();

    let sPath = this._oPersonModel.createKey("/PersonSet", {
        Perno : oData.Perno
    }) // 경로를 만들어줌. 예시: "/PersonSet('1000')"

    this._oPersonModel.remove(sPath, {
        success: function() {
            sap.m.MessageToast.show("삭제 완료!");
        },
        error: function() {
            sap.m.MessageToast.show("삭제 에러!");
        }
    })
}
```
- SAP GUI 코드
```abap
" ZCL_ZCODE_PERSON2_DPC_EXT : PERSONSET_DELETE_ENTITY
  method PERSONSET_DELETE_ENTITY.
    DATA: ls_data   TYPE zcl2person.

    LOOP AT it_key_tab INTO DATA(ls_key).
      CASE ls_key-name.
        WHEN 'Perno'.
          ls_data-perno = ls_key-value.
      ENDCASE.
    ENDLOOP.

    DELETE zcl2person FROM ls_data.
  endmethod.
```
</br>
</br>

---

</br>

## < 실습 코드 >
</br>

### 실습 1
- 필터 사용
<img width="599" height="281" alt="image" src="https://github.com/user-attachments/assets/bbf57f49-9fde-4002-ae11-17dfa2646b23" />

</br>
</br>

**1) SAP GUI 코드**
```abap
" ZCL_ZGWEMP_B03_DPC_EXT : EMPLOYEESET_GET_ENTITYSET
  method EMPLOYEESET_GET_ENTITYSET.
    DATA: lv_where_clause TYPE string.
        " 전체 필터 조건을 SQL WHERE 절 문자열로 변환
        lv_where_clause = io_tech_request_context->get_osql_where_clause( ).
        SELECT * FROM ztempinfo_b03
          INTO CORRESPONDING FIELDS OF TABLE et_entityset
          WHERE (lv_where_clause).
*    DATA: lr_memo TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_role TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_projod TYPE /IWBEP/T_COD_SELECT_OPTIONS,
*          lr_date TYPE /IWBEP/T_COD_SELECT_OPTIONS.
*
*    IF it_filter_select_options IS INITIAL.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset.
*    ELSE.
*      " 만약 필터 정보가 들어왔다면, 필터 적용
*      LOOP AT it_filter_select_options INTO DATA(ls_filter).
*        CASE ls_filter-property.
*          WHEN 'Memo'.
*            APPEND LINES OF ls_filter-select_options TO lr_memo.
*          WHEN 'Role'.
*            APPEND LINES OF ls_filter-select_options TO lr_role.
*          WHEN 'Projod'.
*            APPEND LINES OF ls_filter-select_options TO lr_projod.
*          WHEN 'Assigndate'.
*            APPEND LINES OF ls_filter-select_options TO lr_date.
*          WHEN OTHERS.
*        ENDCASE.
*      ENDLOOP.
*
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset
*        WHERE Memo IN lr_memo
*          AND Role IN lr_role
*          AND projod IN lr_projod
*          AND assigndate IN lr_date.
*    ENDIF.
**********************************************************************
*    IF iv_filter_string IS INITIAL.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset.
*    ELSE.
*      SELECT * FROM ztempinfo_b03
*        INTO CORRESPONDING FIELDS OF TABLE et_entityset
*        WHERE (iv_filter_string).
*    ENDIF.
  endmethod.
```
</br>

**2) Main.controller.js**
```java
sap.ui.define([
    "sap/ui/core/mvc/Controller",
    "sap/ui/model/Filter", 
    "sap/ui/model/FilterOperator"
], (Controller, Filter, FilterOperator) => {
    "use strict";

    return Controller.extend("project1.controller.Main", {
        onInit() {
            this.oModel = this.getOwnerComponent().getModel();
        },
        onPress: function() {
            let oTable = this.getView().byId("idEmployee");
            let oItem = oTable.getSelectedItem();
            let oData = oItem.getBindingContext().getObject();
            this.oModel.read(`/EmployeeSet(Empno='${oData.Empno}',Projod='${oData.Projod}')`, {
                success: function(oReturn) {
                    sap.m.MessageBox.information(
                        `Empno:  ${oReturn.Empno}
                        Memo:  ${oReturn.Memo} 
                        Projod:  ${oReturn.Projod} 
                        Role:  ${oReturn.Role} `,
                        { title: "m.table 버튼 조회" }
                    );
                }.bind(this),
                error: function(oError) {
                    console.log("Read EntitySet 에러!", oError);
                }
            })
        },
        onSelectionChange: function(oEvent) {
            let sPath = oEvent.getParameters().listItem.getBindingContext().getPath();
            let oData = this.oModel.getProperty(sPath);
            this.oModel.read(`/EmployeeSet(Empno='${oData.Empno}',Projod='${oData.Projod}')`, {
                success: function(oReturn) {
                    sap.m.MessageBox.information(
                        `Empno:  ${oReturn.Empno}
                        Memo:  ${oReturn.Memo} 
                        Projod:  ${oReturn.Projod} 
                        Role:  ${oReturn.Role} `,
                        { title: "m.table 행 클릭 조회" }
                    );
                }.bind(this),
                error: function(oError) {
                    console.log("Read EntitySet 에러!", oError);
                }
            })
        },
        onReadEntitySet: function() {
            // new Filter(path, operator, value1, value2(operator가 BT 인 경우에 씀))
            
            // let aFilter = []
            // let oFilter = new Filter("Memo", FilterOperator.Contains, "TEST2 MEMO");
            // aFilter.push(oFilter);
            let oDateFormat = sap.ui.core.format.DateFormat.getInstance({
                pattern: "yyyyMMdd",
                UTC: true
            });
            let oStartDate = oDateFormat.parse("20260119");
            let oEndDate = oDateFormat.parse("20260701");

            let oFilter = [];
            oFilter.push(new Filter("Memo", FilterOperator.Contains, "TEST2 MEMO"));
            // oFilter.push(new Filter("Role", FilterOperator.Contains, "TEST2"));
            // oFilter.push(new Filter("Projod", FilterOperator.NE, "TEST2")); // 5000번 데이터 띄우기
            oFilter.push(new Filter("Assigndate", FilterOperator.BT, oStartDate, oEndDate));

            this.oModel.read("/EmployeeSet", {
                filters: oFilter, //aFilters,
                success: function(oReturn) {
                    sap.m.MessageToast.show("조회 완료, 콘솔창 확인!");
                    console.log("onReadEntitySet 전체 조회 성공 : ", oReturn.results);
                }
            })
        },
        onPress2: function() {
            let oTable = this.byId("idEmployee2");
            let oIndex = oTable.getSelectedIndex();

            if (oIndex < 0) return sap.m.MessageToast.show("데이터를 선택하세요.");

            let oData = oTable.getContextByIndex(oIndex).getObject();
            let sPath = `/EmployeeSet(Empno='${oData.Empno}',Projod='${oData.Projod}')`;
            // 위와 같이 전체 데이터를 가져와서, sPath 를 구성할 수도 있고,
            // this.byId("idTable").getContextByIndex(iSelectNo).getPath() 를 사용해서
            // 해당 Row의 바인딩 경로 문자열 전체를 얻을 수도 있음 
            this.oModel.read(sPath, {
                success: function(oReturn) {
                    sap.m.MessageToast.show("ui.table 버튼으로 1건 조회", oReturn);
                }.bind(this),
                error: function(oError) {
                    console.log("Read EntitySet 에러!", oError);
                }
            })
        },
        onRowSelect: function(oEvent) {
            let oRowIndex = oEvent.getParameter("rowIndex");
            let oContext = oEvent.getParameter("rowContext");
            let oData = oContext.getObject();
            this.oModel.read(`/EmployeeSet(Empno='${oData.Empno}',Projod='${oData.Projod}')`, {
                success: function(oReturn) {
                    sap.m.MessageBox.information(
                        `Empno:  ${oReturn.Empno}
                        Memo:  ${oReturn.Memo} 
                        Projod:  ${oReturn.Projod} 
                        Role:  ${oReturn.Role} `,
                        { title: "ui.table 행 클릭 조회" }
                    );
                }.bind(this),
                error: function(oError) {
                    console.log("Read EntitySet 에러!", oError);
                }
            })
        }
    });
});
```
</br>

**3) Main.view.xml**
```html
<mvc:View controllerName="project1.controller.Main"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:t="sap.ui.table"
    xmlns="sap.m">
    <Page id="page" title="{i18n>title}">
        <VBox >
            <Table id="idEmployee"
                class="sapUiSmallMarginBottom"
                inset="false"
                mode="SingleSelectLeft"
                selectionChange="onSelectionChange"
                items="{/EmployeeSet}">
                <headerToolbar>
                    <OverflowToolbar>
                        <content>
                            <Title text="Employee" level="H2"/>
                            <ToolbarSpacer />
                            <Button text="클릭" press="onPress"/>
                        </content>
                    </OverflowToolbar>
                </headerToolbar>
                <infoToolbar>
                    <OverflowToolbar>
                        <Label text="Employee"/>
                    </OverflowToolbar>
                </infoToolbar>
                <columns>
                    <Column><Text text="EMPNO" /></Column>
                    <Column><Text text="PROJOD" /></Column>
                    <Column><Text text="ASSIGNDATE" /></Column>
                    <Column><Text text="ROLE" /></Column>
                    <Column><Text text="MEMO" /></Column>
                </columns>
                <items>
                    <ColumnListItem vAlign="Middle">
                        <cells>
                            <Text text="{Empno}" />
                            <Text text="{Projod}" />
                            <Text text="{
                                path: 'Assigndate',
                                type: 'sap.ui.model.type.DateTime',
                                formatOptions: { pattern : 'yyyy-MM-dd' }
                            }" />
                            <Text text="{Role}" />
                            <Text text="{Memo}" />
                        </cells>
                    </ColumnListItem>
                </items>
            </Table>

            <t:Table rows="{/EmployeeSet}"
                    id="idEmployee2"
                    selectionMode="Single"
                    selectionBehavior="RowOnly"
                    rowSelectionChange="onRowSelect">
                <t:extension>
                    <OverflowToolbar>
                        <Title text="Employee" level="H2"/>
                        <ToolbarSpacer />
                        <Button text="EntitySet" press="onReadEntitySet"/>
                        <Button text="클릭" press="onPress2"/>
                    </OverflowToolbar>
                </t:extension>
                <t:columns>
                    <t:Column>
                        <Label text="EMPNO" />
                        <t:template>
                            <Text text="{Empno}" />
                        </t:template>
                    </t:Column>

                    <t:Column>
                        <Label text="PROJOD" />
                        <t:template>
                            <Text text="{Projod}" />
                        </t:template>
                    </t:Column>

                    <t:Column>
                        <Label text="ASSIGNDATE" />
                        <t:template>
                            <Text text="{
                                path: 'Assigndate',
                                type: 'sap.ui.model.type.DateTime',
                                formatOptions: { pattern : 'yyyy-MM-dd' }
                            }" />
                        </t:template>
                    </t:Column>

                    <t:Column>
                        <Label text="ROLE" />
                        <t:template>
                            <Text text="{Role}" />
                        </t:template>
                    </t:Column>

                    <t:Column>
                        <Label text="MEMO" />
                        <t:template>
                            <Text text="{Memo}" />
                        </t:template>
                    </t:Column>
                </t:columns>
            </t:Table>
        </VBox>
    </Page>
</mvc:View>
```
