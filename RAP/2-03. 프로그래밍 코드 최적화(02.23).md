## <  핵심 개념 >
- **1) Annotation Propagation (필드 참조 + 애노테이션 전파)**
- **2) ABAP Dictionary에서 Foreign Key 설정 문법**
- **3) CDS Association**
- **4) Syntax Warning – Association Cardinality 불일치**
- **5) Association만 사용 vs 실제 JOIN 발생 조건**
- **6) CDS WHERE·필터·집계 함수**
- **7) ABAP SQL Association Path Expression 사용법**
</br>
</br>

---

</br>

## < Annotation Propagation (필드 참조 + 애노테이션 전파) >
- 필드(Element) 애노테이션은 상위 View로 전파되지만, View Entity 수준 애노테이션은 전파되지 않음
- `@Metadata.ignorePropagatedAnnotations: ` : false는 하위 View의 필드 애노테이션을 그대로 전파하고, true는 그 전파를 무시함
- 상위 View에서는 이미 하위 View에서 정의된 별칭(Carrid, Price 등)을 그대로 필드명으로 사용하기 때문에 다시 as를 쓸 필요가 없음
  
</br>

- R_Employee (하위 View)

```abap
@AccessControl.authorizationCheck: #MANDATORY
@EndUserText.label: 'Root Employee View'

define view entity R_Employee
  as select from zemployee
{
  key EmployeeID,
      Name,
      CurrencyCode,

  @Semantics.amount.currencyCode: 'CurrencyCode'
      AnnualSalary
}
```

- C_Employee (상위 View)
```abap
@EndUserText.label: 'Consumption Employee View'

define view entity C_Employee
  as select from R_Employee
{
  key EmployeeID,
      Name,
      AnnualSalary
}
```
</br>

- 기존 CDS View(ZCDSFLIGHT_B03)를 참조해서 새로운 CDS View를 생성하는 화면
<img width="481" height="321" alt="image" src="https://github.com/user-attachments/assets/f07b8aed-5a99-4b47-825c-6fc46fbdc8a5" />
</br>
</br>

- CDS View에서 현재 적용된 Annotation을 확인하기 위해 “Open With → Active Annotations”를 여는 메뉴
<img width="611" height="252" alt="image" src="https://github.com/user-attachments/assets/b822fc3b-2292-4481-b4f3-c287314841fa" />
</br>
</br>

- 해당 CDS View에 실제로 적용·전파된 Annotation 목록을 보여주는 확인 화면
<img width="689" height="349" alt="image" src="https://github.com/user-attachments/assets/d458b047-4524-4156-911d-4e02c99bd134" />
</br>
</br>

- ZCDSFLIGHT_B03 (하위 View)
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Flight CDS View'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSFLIGHT_B03 as select from sflight
{
    key carrid as Carrid,
    key connid as Connid,
    key fldate as Fldate,
    
    @Semantics.amount.currencyCode: 'Currency'
    price as Price,
    currency as Currency,
    planetype as Planetype,
    seatsmax as Seatsmax,
    seatsocc as Seatsocc,
    @Semantics.amount.currencyCode: 'Currency'
    paymentsum as Paymentsum
}
```
- ZCDSFLIGHT_PROPA_B03 (상위 View)
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Flight CDS Propagated'
@Metadata.ignorePropagatedAnnotations: false
define view entity ZCDSFLIGHT_PROPA_B03 as select from ZCDSFLIGHT_B03
{
    key Carrid,
    key Connid,
    key Fldate,
    Price,
    Currency,
    Planetype,
    Seatsmax,
    Seatsocc,
    Paymentsum
}
```
</br>
</br>
</br>
</br>

## < ABAP Dictionary에서 Foreign Key 설정 문법 >
- 왼쪽 (Source/내 테이블)  : 최소 0건 ~ 최대 여러 건(*) 존재 가능
- 오른쪽 (Target/체크 테이블) : 최소 0건 ~ 최대 여러 건(*) 존재 가능
```abap
" [ForeignKey Table(Source), Check Table(Target)]

" [1,1]       → Source 1건은 Target 1건과 반드시 연결, Target도 Source 1건만 가질 수 있음
" [0..1,1]    → Source는 Target과 연결 안 될 수도 있고 되면 1건, Target은 Source 1건 반드시 필요
" [1..*,1]    → Source는 반드시 Target 1건과 연결, 여러 Source가 같은 Target에 연결 가능
" [0..*,1]    → Source는 연결 안 될 수도 있고 되면 1건, 여러 Source가 같은 Target에 연결 가능
" [0..1,0..1] → Source와 Target 모두 선택적, 서로 없어도 됨
```
```abap
define table employee {

  key client       : abap.clnt not null;      // 클라이언트 (PK)
  key employee_id  : employee_id not null;   // 직원 ID (PK)

  department_id : department_id              // Check Field (외래키 필드)
    with foreign key department              // Check Table = DEPARTMENT
      where client = employee.client         // Check Table PK의 client 매핑
        and id     = employee.department_id; // Check Table PK의 id 매핑
}
```
</br>
</br>
</br>
</br>

## < CDS Association >
- CDS View와 다른 CDS View를 연결해두는 관계 정의 문법 (필요할 때 자동으로 조인되도록 예약)
- `$projection` : 현재 CDS Entity의 필드를 참조
- Association임을 구분하기 위해 관례적으로 이름 앞에 _를 붙임
```abap
define view entity R_Employee
  as select from employee

  association to R_Department as _Department
    on $projection.DepartmentId = _Department.Id

{
  key employee_id as EmployeeId,
      first_name  as FirstName,
      last_name   as LastName,
      department_id as DepartmentId
}
```
- Association의 `[min..max]` 는 Target 테이블에서 ON 조건에 따라 매칭했을 때, 반환될 수 있는 결과 행(Row)의 최소~최대 개수를 의미
```abap
association [min..max] to TargetView as _Assoc
```
</br>
</br>
</br>
</br>

## < Syntax Warning – Association Cardinality 불일치 >
- ON 조건이 Target의 Primary Key를 완전히 지정하므로 최대 1건만 가능
- 따라서 Cardinality는 `[0..1]` 또는 `[1..1]` 로 선언해야 올바름
```abap
define view entity R_Employee
  as select from employee

  association [0..*] to R_Department as _Department
    on $projection.DepartmentId = _Department.Id
{
  key employee_id  as EmployeeId,
      department_id as DepartmentId
}
```
```abap
define view entity R_Department
  as select from department
{
  key id as Id,
      department_designation as DepartmentDesignation
}
```
</br>
</br>

- Association Cardinality는 Target 쪽 PK 기준으로 판단
- Association Cardinality 종류 : `[0..1]` , `[1..1]` , `[0..*]` , `[1..*]`
- Target의 PK를 기준으로 매핑하면 결과는 최대 1건이라 *가 불가능하고, PK가 아닌 필드로 매핑하면 여러 건 가능함
- ON 조건은 반드시 Primary Key일 필요는 없음
- 복합 PK를 전부 매핑 → 최대 1건 / 복합 PK를 일부만 매핑 → 여러 건 가능
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Cds View spfli'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSSPFLI_B03 as select from spfli as sf
    // association 생략 시 기본값은 [0..1]
    association[1..1] to ZCDSSCARR2_B03 as _Carrier  // [0..1] 또는 [1..1] 이어야 함
    // on $projection.Carr_id = _Carrier.Carrid
    on sf.carrid = _Carrier.Carrid
{
    key carrid as Carr_id,
    key connid as Connid,
    countryfr as Countryfr,
    cityfrom as Cityfrom,
    airpfrom as Airpfrom,
    countryto as Countryto,
    cityto as Cityto,
    airpto as Airpto,
    fltime as Fltime,
    deptime as Deptime,
    arrtime as Arrtime,
    @Semantics.quantity.unitOfMeasure: 'Distid'
    distance as Distance,
    distid as Distid,
    fltype as Fltype,
    period as Period,
    _Carrier       
}
```
<img width="536" height="315" alt="image" src="https://github.com/user-attachments/assets/de5cb776-7322-42c3-b277-47b0f87768fe" />
</br>

<img width="285" height="174" alt="image" src="https://github.com/user-attachments/assets/d8b639b2-b26c-4946-b5d7-9c0f8428ca16" />
</br>
</br>
</br>
</br>
</br>
</br>

## < Association만 사용 vs 실제 JOIN 발생 조건 >
- `_Department` 만 쓰면 관계 선언일 뿐이고, `_Department.필드` 까지 써야 JOIN 발생
```abap
define view entity C_Employee
  as select from R_Employee
    association [0..1] to R_Department as _Department   // 부서와 연결
      on $projection.DepartmentId = _Department.Id      // 조인 조건
{
  key EmployeeId,               // 직원 ID (PK)
      FirstName,                // 이름
      LastName,                 // 성
      DepartmentId,             // 부서 ID

      _Department.DependentDesignation  // 부서 테이블 필드 접근
}
```
```abap
define view entity C_Employee
  as select from R_Employee
    association [0..1] to R_Department as _Department   // 부서와 연결
      on $projection.DepartmentId = _Department.Id      // 조인 조건
{
  key EmployeeId,               // 직원 ID (PK)
      FirstName,                // 이름
      LastName,                 // 성
      DepartmentId,             // 부서 ID

      _Department               // 조인 발생 X
}
```
</br>
</br>

---

</br>

## < CDS WHERE·필터·집계 함수 >
</br>

### 1) CDS WHERE 
- where절을 사용해 필터링 가능
- `[0..*]` 또는 `[1..*]` 와 같이 max가 *인 관계에서 association 필드로 WHERE 조건을 주면 결과 행 수가 변할 수 있어서 사용 불가
- `_Department._Head.LastName` 처럼 연속 Path Expression을 쓰면, Association 단계 수만큼 JOIN이 자동 생성됨
```abap
where <기준테이블.필드> = <값>
  and <1:1 Association.필드> = <값>
  // and <1:N Association.필드> = <값>   // [*] 관계이므로 사용 불가
```

- `WHERE` 사용 → 예: WHERE _Dept.Name = 'A'
- `SELECT { }` 사용 → 예: _Dept.Name
- 둘 다 안 쓰면 → Association은 관계만 정의, 실제 JOIN 안 발생

| WHERE 사용 | SELECT { } 사용 | JOIN 발생 |
|------------|----------------|-----------|
| X          | X              | No        |
| X          | O              | Yes       |
| O          | X              | Yes       |
| O          | O              | Yes       |

</br>
</br>
</br>

### 2) CDS 집계함수 

- 집계함수를 사용하려면 Association의 Target Cardinality는 * 이어야 함
- 집계하기 직전에 `_flight[ Seatsocc = Seatsmax ]` 처럼 특정 조건에 맞는 데이터만 골라낸 뒤 집계할 수 있음
- 집계 함수(max, min, sum, avg 등)를 사용하면, 집계 대상이 아닌 모든 필드는 반드시 group by에 포함해야 함
- `distinct` 는 중복된 값을 제거하고 서로 다른 값만 계산하거나 조회하는 옵션
```abap
{
      min( <1:N Association[조건].필드> )        as <별칭>,
      max( <1:N Association.필드> )              as <별칭>,
      count( distinct <1:N Association.필드> )   as <별칭>
}

group by
      <집계가 아닌 모든 선택 필드>
```
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Cds View spfli'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSSPFLI_B03
  as select from spfli as sf
  // association 생략 시 기본값은 [0..1]
  association [1..1] to ZCDSSCARR2_B03  as _Carrier
  // on $projection.Carr_id = _Carrier.Carrid
  on  sf.carrid = _Carrier.Carrid
  association [*]    to ZCDSFLIGHT2_B03 as _flight // [0..*]
  on  sf.carrid = _flight.Carrid
  and sf.connid = _flight.Connid
{
  key carrid                as Carr_id,
  key connid                as Connid,
      countryfr             as Countryfr,
      countryto             as Countryto,
      // 필터 적용
      // _FLight 데이터 셋 중에 Seatsocc = Seatsmax 인 데이터들 추출 (필터)
      // 조회된 데이터 중 fldate가 가장 작은 값을 minFlight 이라는 이름으로 조회
      min( _flight[ Seatsocc = Seatsmax ].Fldate ) as minFlight,
      max( _flight.Fldate ) as maxFlight,
      count( distinct _flight.Fldate ) as cntFlight,
      
      _Carrier,
      _flight
      //      _Carrier.Carrname as Carrname,
      //      _flight.Fldate    as FlightDate


}
// where carrid = 'AA'     // where절 옆 필드는 db 필드 기준
// where _flight.Seatsocc > 100     // 카디널리티가 *로 설정되어 있으므로 사용 불가
where
  _Carrier.Carrid = 'AA'
group by
  carrid,
  connid,
  countryfr,
  countryto
```
</br>
</br>

### 3) CDS 필터 

- `1:` 은 필터 결과가 최대 1건이라고 명시하는 카디널리티 선언
- `[ <조건> ]` 은 association 내부 데이터 중 조건을 만족하는 행만 선택하는 필터 표현
```abap
<Association>[ <조건> ].<필드>                 as <별칭>
<Association>[ 1: <조건> ].<필드>              as <별칭>   // 결과 1건 보장
```
- Language 조건으로 조회했을 때 동일 Currency에 대해 두 행 이상 존재하면 1: 사용 시 카디널리티 위반

  - 정상: EN으로 된 이름이 'United States Dollar' 딱 하나일 때.
  - 에러: EN으로 된 이름이 'Dollar'와 'US Dollar' 두 개가 있을 때.
- `$session.system_language` : 현재 로그인한 사용자의 SAP 세션 언어값 (예: KO, EN 등)
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Scarr CDS View 2'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSSCARR2_B03 as select from scarr
  association[0..*] to I_CurrencyText as _Text
    on $projection.Currcode = _Text.Currency
{
  key carrid   as Carrid,   // 주석은 이렇게
      carrname as Carrname,  // 주석 !!
      currcode as Currcode,
      
      _Text[ 1: Language = $session.system_language ].CurrencyName as CurrName  // EN
      // 접속 언어(Language) 조건으로 검색했을 때, 이 통화(Currency)에 연결된 텍스트 데이터는 단 한 줄뿐
}
```
</br>
</br>
</br>

## < ABAP SQL Association Path Expression 사용법 >
- JOIN을 직접 쓰지 않고 Association 경로로 데이터를 조회하는 방식
- 상위 뷰는 하위 뷰를 select 하면, 그 안의 Association 경로도 함께 물려받아 그대로 사용할 수 있음 (재정의 불필요)
- 상위 뷰에서 `select from 하위뷰` 하면, 하위 뷰가 SELECT 해둔 일반 필드는 경로 없이 바로 SELECT 가능함
- `\` → Association 시작 표시
- `-` → Association 끝에서 실제 필드를 지정하는 구분자
- `\_A\_B-Field` → Association을 연속으로 타고 들어가 최종 필드 조회
- `MANY TO ONE` → 여러 건 중 1건으로 좁히는 경로임을 컴파일러에게 명시
```abap
SELECT FROM <CDS_View>
  FIELDS
    <기준필드>,
    \ <Association>-<필드>
  INTO TABLE @DATA(<내부테이블>).
```
```abap
REPORT ZASSO_B03.

SELECT FROM ZCDSSCARR2_B03
  FIELDS CARRID, CARRNAME,
         \_Text[ MANY TO ONE WHERE Language = 'E' ]-language
  INTO TABLE @DATA(gt_result).

IF sy-subrc = 0.
  cl_demo_output=>display( gt_result ).
ENDIF.
```

</br>
</br>
</br>
</br>
</br>

---

</br>

## < 실습 코드 >
</br>

### 실습 1
- Annotation Propagation 실습
</br>

<img width="474" height="297" alt="image" src="https://github.com/user-attachments/assets/4cc81c0b-2eac-449b-8cd6-7156687d1495" />
</br>
</br>

- Z03_R_Employee (하위 View)
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_R_Employee'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_R_Employee as select from z03employ
{
    key employee_id as EmployeeId,
    first_name as FirstName,
    last_name as LastName,
    birth_date as BirthDate,
    entry_date as EntryDate,
    @Semantics.amount.currencyCode: 'CurrencyCode'
    annual_salary         as AnnualSalary,
    @EndUserText.label: 'Currency Key'
    currency_code         as CurrencyCode,
    created_by as CreatedBy,
    created_at as CreatedAt,
    local_last_changed_by as LocalLastChangedBy,
    local_last_changed_at as LocalLastChangedAt,
    last_changed_at as LastChangedAt
}
```
- Z03_C_Employee (하위 View)
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_C_Employee'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_C_Employee as select from Z03_R_Employee
{
    key EmployeeId,
    FirstName,
    LastName,
    BirthDate,
    EntryDate,
    @Semantics.amount.currencyCode: 'CurrencyCode'
    AnnualSalary,
    CurrencyCode,
    CreatedBy,
    CreatedAt,
    LocalLastChangedBy,
    LocalLastChangedAt,
    LastChangedAt
}
```
</br>
</br>
</br>

### 실습 2
- View (구문법) CDS 생성 실습
</br>

<img width="356" height="204" alt="image" src="https://github.com/user-attachments/assets/3e2716d1-25e3-4c1e-be57-7aece1196181" />
</br>
</br>
</br>
</br>

<img width="474" height="301" alt="image" src="https://github.com/user-attachments/assets/4b212780-8392-4da7-8d25-1e970c7ddf60" />
</br>

```abap
@AbapCatalog.sqlViewName: 'ZCDSEMP_B03_S'
@AbapCatalog.compiler.compareFilter: true
@AbapCatalog.preserveKey: true
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'CDS Employ Info'
@Metadata.ignorePropagatedAnnotations: true
define view ZCDSEMPINFO_B03 as select from ztempinfo_b03
{
  key empno as EmployNo,
  key projod as ProjectID,
  assigndate as AssignDate,
  role as Role,
  memo as Memo
}
```
</br>
</br>
</br>

### 실습 3
- Foreign Key 설정 실습
- Association Cardinality 실습

<img width="306" height="172" alt="image" src="https://github.com/user-attachments/assets/b7125276-b60a-410d-a205-e553fc765909" />
</br>
</br>
</br>

- DB Table `z03depment` Foreign Key 설정
- `@AbapCatalog.foreignKey.screenCheck` 은 기본값이 true이며, false로 설정하면 화면 입력 시 외래키 체크를 수행하지 않도록 함
```abap
@EndUserText.label : 'Department (with Foreign Key Relations)'
@AbapCatalog.enhancement.category : #NOT_EXTENSIBLE
@AbapCatalog.tableCategory : #TRANSPARENT
@AbapCatalog.deliveryClass : #A
@AbapCatalog.dataMaintenance : #RESTRICTED
define table z03depment {

  key client   : abap.clnt not null;
  key id       : /lrn/department_id not null;
  description  : /lrn/depment_description;
  @AbapCatalog.foreignKey.screenCheck : false
  head_id      : /lrn/depment_head
    with foreign key [0..1,0..1] /lrn/employ_rel
      where client = z03depment.client
        and employee_id = z03depment.head_id;
  @AbapCatalog.foreignKey.screenCheck : false
  assistant_id : /lrn/depment_assistant
    with foreign key [0..1,1] /lrn/employ_rel
      where client = z03depment.client
        and employee_id = z03depment.assistant_id;
  include /lrn/s_admin;

}
```
- CDS `Z03_R_Employee` Association Cardinality 맞추기
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_R_Employee'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_R_Employee as select from z03employ
  association [1..1] to Z03_R_Department as _Department
    on $projection.DepartmentId = _Department.Id
{
    key employee_id as EmployeeId,
    first_name as FirstName,
    last_name as LastName,
    birth_date as BirthDate,
    entry_date as EntryDate,
    department_id as DepartmentId,
    @Semantics.amount.currencyCode: 'CurrencyCode'
    annual_salary         as AnnualSalary,
    @EndUserText.label: 'Currency Key'
    currency_code         as CurrencyCode,
    created_by as CreatedBy,
    created_at as CreatedAt,
    local_last_changed_by as LocalLastChangedBy,
    local_last_changed_at as LocalLastChangedAt,
    last_changed_at as LastChangedAt,
    
    _Department
}
```
- CDS `Z03_R_Department` Association Cardinality 맞추기
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_R_Department'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_R_Department
  as select from z03depment
  association[0..*] to Z03_R_Employee as _Employee
    on $projection.Id = _Employee.DepartmentId
  association [0..1] to Z03_R_Employee as _Head
    on $projection.HeadId = _Head.EmployeeId
  association [1..1] to Z03_R_Employee as _Assistant
    on $projection.AssistantId = _Assistant.EmployeeId
{
  key id                    as Id,
      description           as Description,
      head_id               as HeadId,
      assistant_id          as AssistantId,
      created_by            as CreatedBy,
      created_at            as CreatedAt,
      local_last_changed_by as LocalLastChangedBy,
      local_last_changed_at as LocalLastChangedAt,
      last_changed_at       as LastChangedAt,
      
      _Employee,
      _Head,
      _Assistant
}
```
</br>
</br>
</br>

### 실습 4
- ABAP SQL Association Path Expression 실습
- `_Department` <-- 이렇게 하위에 이름이 나와 있어야 상위에서 부를 수 있음
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_C_EmployeeQuery'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_C_EmployeeQuery as select from Z03_R_Employee
{
    key EmployeeId,
    FirstName,
    LastName,
    DepartmentId,
    
    _Department.Description as DepartmentDescription,
    _Department._Assistant.LastName as AssistantName,
    
    _Department
}
```
```abap
CLASS Z03_C_EMPLOYEQUERY IMPLEMENTATION.
  METHOD if_oo_adt_classrun~main.
    SELECT FROM Z03_C_EmployeeQuery
        FIELDS employeeid,
               firstname,
               lastname,
               departmentid,

               DepartmentDescription,
               AssistantName,
               \_Department\_Head-LastName as HEADNAME
    INTO TABLE @DATA(result).
    out->write( result ).
  ENDMETHOD.
ENDCLASS.
```
