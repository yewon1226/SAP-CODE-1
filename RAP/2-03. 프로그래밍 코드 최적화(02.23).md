## <  핵심 개념 >
- **1) Annotation Propagation (필드 참조 + 애노테이션 전파)**
</br>
</br>

---

</br>

## < Annotation Propagation (필드 참조 + 애노테이션 전파) >
- 필드(Element) 애노테이션은 상위 View로 자동 전파되고, View Entity 애노테이션은 전파되지 않음
- `@Metadata.ignorePropagatedAnnotations: ` : false는 하위 View의 필드 애노테이션을 그대로 전파하고, true는 그 전파를 무시함
- 상위 View에서는 이미 하위 View에서 정의된 별칭(Carrid, Price 등)을 그대로 필드명으로 사용하기 때문에 다시 as를 쓸 필요가 없음
  
</br>

- R_Employee (하위 View)

```abap
@AccessControl.authorizationCheck: #MANDATORY
@EndUserText.label: 'Root Employee View'

define view entity R_Employee
  as select from zemployee
{
  key EmployeeID,
      Name,
      CurrencyCode,

  @Semantics.amount.currencyCode: 'CurrencyCode'
      AnnualSalary
}
```

- C_Employee (상위 View)
```abap
@EndUserText.label: 'Consumption Employee View'

define view entity C_Employee
  as select from R_Employee
{
  key EmployeeID,
      Name,
      AnnualSalary
}
```
</br>

- 기존 CDS View(ZCDSFLIGHT_B03)를 참조해서 새로운 CDS View를 생성하는 화면
<img width="481" height="321" alt="image" src="https://github.com/user-attachments/assets/f07b8aed-5a99-4b47-825c-6fc46fbdc8a5" />
</br>
</br>

- CDS View에서 현재 적용된 Annotation을 확인하기 위해 “Open With → Active Annotations”를 여는 메뉴
<img width="611" height="252" alt="image" src="https://github.com/user-attachments/assets/b822fc3b-2292-4481-b4f3-c287314841fa" />
</br>
</br>

- 해당 CDS View에 실제로 적용·전파된 Annotation 목록을 보여주는 확인 화면
<img width="689" height="349" alt="image" src="https://github.com/user-attachments/assets/d458b047-4524-4156-911d-4e02c99bd134" />
</br>
</br>

- ZCDSFLIGHT_B03 (하위 View)
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Flight CDS View'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSFLIGHT_B03 as select from sflight
{
    key carrid as Carrid,
    key connid as Connid,
    key fldate as Fldate,
    
    @Semantics.amount.currencyCode: 'Currency'
    price as Price,
    currency as Currency,
    planetype as Planetype,
    seatsmax as Seatsmax,
    seatsocc as Seatsocc,
    @Semantics.amount.currencyCode: 'Currency'
    paymentsum as Paymentsum
}
```
- ZCDSFLIGHT_PROPA_B03 (상위 View)
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Flight CDS Propagated'
@Metadata.ignorePropagatedAnnotations: false
define view entity ZCDSFLIGHT_PROPA_B03 as select from ZCDSFLIGHT_B03
{
    key Carrid,
    key Connid,
    key Fldate,
    Price,
    Currency,
    Planetype,
    Seatsmax,
    Seatsocc,
    Paymentsum
}
```
</br>
</br>
</br>
</br>

## < ABAP Dictionary에서 Foreign Key 설정 문법 >

- `[1,1]` → Source 1건은 Target 1건과 매핑 (일대일)
- `[0..1,1]` → Source 1건당 Target이 없거나 1건
- `[1..*,1]` → 여러 Source가 Target 1건을 참조 (다대일)
- `[0..*,1]` → 여러 Source가 Target 1건을 참조 가능
```abap
[ForeignKey Table(Source), Check Table(Target)]
with foreign key [0..*, 1]
```
```abap
define table employee {

  key client       : abap.clnt not null;      // 클라이언트 (PK)
  key employee_id  : employee_id not null;   // 직원 ID (PK)

  department_id : department_id              // Check Field (외래키 필드)
    with foreign key department              // Check Table = DEPARTMENT
      where client = employee.client         // Check Table PK의 client 매핑
        and id     = employee.department_id; // Check Table PK의 id 매핑
}
```
</br>
</br>
</br>
</br>

## < CDS Association >
- CDS View와 다른 CDS View를 연결해두는 관계 정의 문법 (필요할 때 자동으로 조인되도록 예약)
- `$projection` : 현재 CDS Entity의 필드를 참조
- Association임을 구분하기 위해 관례적으로 이름 앞에 _를 붙임
```abap
define view entity R_Employee
  as select from employee

  association to R_Department as _Department
    on $projection.DepartmentId = _Department.Id

{
  key employee_id as EmployeeId,
      first_name  as FirstName,
      last_name   as LastName,
      department_id as DepartmentId
}
```
- Association의 `[min..max]` 는 Source 1건 기준으로 Target이 몇 건 연결되는지를 나타냄
```abap
association [min..max] to TargetView as _Assoc
```
</br>
</br>
</br>
</br>

## < Syntax Warning – Association Cardinality 불일치 >
- ON 조건이 Target의 Primary Key를 완전히 지정하므로 최대 1건만 가능
- 따라서 Cardinality는 `[0..1]` 또는 `[1..1]` 로 선언해야 올바름
```abap
define view entity R_Employee
  as select from employee

  association [0..*] to R_Department as _Department
    on $projection.DepartmentId = _Department.Id
{
  key employee_id  as EmployeeId,
      department_id as DepartmentId
}
```
```abap
define view entity R_Department
  as select from department
{
  key id as Id,
      department_designation as DepartmentDesignation
}
```
</br>
</br>

- Association Cardinality는 Target 쪽 PK 기준으로 판단
- Association Cardinality 종류 : `[0..1]` , `[1..1]` , `[0..*]` , `[1..*]`
- Target의 PK를 기준으로 매핑하면 결과는 최대 1건이라 *가 불가능하고, PK가 아닌 필드로 매핑하면 여러 건 가능함
- ON 조건은 반드시 Primary Key일 필요는 없음
- 복합 PK를 전부 매핑 → 최대 1건 / 복합 PK를 일부만 매핑 → 여러 건 가능
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Cds View spfli'
@Metadata.ignorePropagatedAnnotations: true
define view entity ZCDSSPFLI_B03 as select from spfli as sf
    // association 생략 시 기본값은 [0..1]
    association[1..1] to ZCDSSCARR2_B03 as _Carrier  // [0..1] 또는 [1..1] 이어야 함
    // on $projection.Carr_id = _Carrier.Carrid
    on sf.carrid = _Carrier.Carrid
{
    key carrid as Carr_id,
    key connid as Connid,
    countryfr as Countryfr,
    cityfrom as Cityfrom,
    airpfrom as Airpfrom,
    countryto as Countryto,
    cityto as Cityto,
    airpto as Airpto,
    fltime as Fltime,
    deptime as Deptime,
    arrtime as Arrtime,
    @Semantics.quantity.unitOfMeasure: 'Distid'
    distance as Distance,
    distid as Distid,
    fltype as Fltype,
    period as Period,
    _Carrier       
}
```
<img width="536" height="315" alt="image" src="https://github.com/user-attachments/assets/de5cb776-7322-42c3-b277-47b0f87768fe" />
</br>

<img width="285" height="174" alt="image" src="https://github.com/user-attachments/assets/d8b639b2-b26c-4946-b5d7-9c0f8428ca16" />
</br>
</br>
</br>
</br>
</br>
</br>

## < Association만 사용 vs 실제 JOIN 발생 조건 >
- `_Department` 만 쓰면 관계 선언일 뿐이고, `_Department.필드` 까지 써야 JOIN 발생
```abap
define view entity C_Employee
  as select from R_Employee
    association [0..1] to R_Department as _Department   // 부서와 연결
      on $projection.DepartmentId = _Department.Id      // 조인 조건
{
  key EmployeeId,               // 직원 ID (PK)
      FirstName,                // 이름
      LastName,                 // 성
      DepartmentId,             // 부서 ID

      _Department.DependentDesignation  // 부서 테이블 필드 접근
}
```
</br>
</br>
</br>
</br>
</br>

---

</br>

## < 실습 코드 >
</br>

### 실습 1
- Annotation Propagation 실습
</br>

<img width="474" height="297" alt="image" src="https://github.com/user-attachments/assets/4cc81c0b-2eac-449b-8cd6-7156687d1495" />
</br>
</br>

- Z03_R_Employee (하위 View)
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_R_Employee'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_R_Employee as select from z03employ
{
    key employee_id as EmployeeId,
    first_name as FirstName,
    last_name as LastName,
    birth_date as BirthDate,
    entry_date as EntryDate,
    @Semantics.amount.currencyCode: 'CurrencyCode'
    annual_salary         as AnnualSalary,
    @EndUserText.label: 'Currency Key'
    currency_code         as CurrencyCode,
    created_by as CreatedBy,
    created_at as CreatedAt,
    local_last_changed_by as LocalLastChangedBy,
    local_last_changed_at as LocalLastChangedAt,
    last_changed_at as LastChangedAt
}
```
- Z03_C_Employee (하위 View)
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_C_Employee'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_C_Employee as select from Z03_R_Employee
{
    key EmployeeId,
    FirstName,
    LastName,
    BirthDate,
    EntryDate,
    @Semantics.amount.currencyCode: 'CurrencyCode'
    AnnualSalary,
    CurrencyCode,
    CreatedBy,
    CreatedAt,
    LocalLastChangedBy,
    LocalLastChangedAt,
    LastChangedAt
}
```
</br>
</br>
</br>

### 실습 2
- View (구문법) CDS 생성 실습
</br>

<img width="356" height="204" alt="image" src="https://github.com/user-attachments/assets/3e2716d1-25e3-4c1e-be57-7aece1196181" />
</br>
</br>
</br>
</br>

<img width="474" height="301" alt="image" src="https://github.com/user-attachments/assets/4b212780-8392-4da7-8d25-1e970c7ddf60" />
</br>

```abap
@AbapCatalog.sqlViewName: 'ZCDSEMP_B03_S'
@AbapCatalog.compiler.compareFilter: true
@AbapCatalog.preserveKey: true
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'CDS Employ Info'
@Metadata.ignorePropagatedAnnotations: true
define view ZCDSEMPINFO_B03 as select from ztempinfo_b03
{
  key empno as EmployNo,
  key projod as ProjectID,
  assigndate as AssignDate,
  role as Role,
  memo as Memo
}
```
</br>
</br>
</br>

### 실습 3
- Foreign Key 설정 실습
- Association Cardinality 실습

<img width="306" height="172" alt="image" src="https://github.com/user-attachments/assets/b7125276-b60a-410d-a205-e553fc765909" />
</br>
</br>
</br>

- DB Table `z03depment` Foreign Key 설정
```abap
@EndUserText.label : 'Department (with Foreign Key Relations)'
@AbapCatalog.enhancement.category : #NOT_EXTENSIBLE
@AbapCatalog.tableCategory : #TRANSPARENT
@AbapCatalog.deliveryClass : #A
@AbapCatalog.dataMaintenance : #RESTRICTED
define table z03depment {

  key client   : abap.clnt not null;
  key id       : /lrn/department_id not null;
  description  : /lrn/depment_description;
  @AbapCatalog.foreignKey.screenCheck : false
  head_id      : /lrn/depment_head
    with foreign key [0..1,0..1] /lrn/employ_rel
      where client = z03depment.client
        and employee_id = z03depment.head_id;
  @AbapCatalog.foreignKey.screenCheck : false
  assistant_id : /lrn/depment_assistant
    with foreign key [0..1,1] /lrn/employ_rel
      where client = z03depment.client
        and employee_id = z03depment.assistant_id;
  include /lrn/s_admin;

}
```
- CDS `Z03_R_Employee` Association Cardinality 맞추기
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_R_Employee'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_R_Employee as select from z03employ
  association [1..1] to Z03_R_Department as _Department
    on $projection.DepartmentId = _Department.Id
{
    key employee_id as EmployeeId,
    first_name as FirstName,
    last_name as LastName,
    birth_date as BirthDate,
    entry_date as EntryDate,
    department_id as DepartmentId,
    @Semantics.amount.currencyCode: 'CurrencyCode'
    annual_salary         as AnnualSalary,
    @EndUserText.label: 'Currency Key'
    currency_code         as CurrencyCode,
    created_by as CreatedBy,
    created_at as CreatedAt,
    local_last_changed_by as LocalLastChangedBy,
    local_last_changed_at as LocalLastChangedAt,
    last_changed_at as LastChangedAt,
    
    _Department
}
```
- CDS `Z03_R_Department` Association Cardinality 맞추기
```abap
@AbapCatalog.viewEnhancementCategory: [#NONE]
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Z03_R_Department'
@Metadata.ignorePropagatedAnnotations: true
define view entity Z03_R_Department
  as select from z03depment
  association[0..*] to Z03_R_Employee as _Employee
    on $projection.Id = _Employee.DepartmentId
  association [0..1] to Z03_R_Employee as _Head
    on $projection.HeadId = _Head.EmployeeId
  association [1..1] to Z03_R_Employee as _Assistant
    on $projection.AssistantId = _Assistant.EmployeeId
{
  key id                    as Id,
      description           as Description,
      head_id               as HeadId,
      assistant_id          as AssistantId,
      created_by            as CreatedBy,
      created_at            as CreatedAt,
      local_last_changed_by as LocalLastChangedBy,
      local_last_changed_at as LocalLastChangedAt,
      last_changed_at       as LastChangedAt,
      
      _Employee,
      _Head,
      _Assistant
}
```
