## <  핵심 개념 >
</br>

- **1) FIELD / CHAIN 입력 체크 방식**
- **2) `AT EXIT-COMMAND` - E 타입 메시지 일 때 나가기**

</br>

- **`LEAVE TO SCREEN 0`** 같은 화면 전환 명령은 **`PAI`** 에서만
- **`SCREEN-INPUT`** 같은 화면 속성 변경은 **`PBO`** 에서만
- 사용자 입력 기반 SELECT는 **`PAI`** , 조회 결과 화면 반영/속성 변경은 **`PBO`**
- **OK_CODE 초기화** 코드 꼭 넣어줘야 함 ( 보통 **`PBO`** 에서)
- **`OK_CODE`** 케이스문은 **`PAI`** 에서
- LOOP AT SCREEN 사용시 **`MODIFY SCREEN`** 넣기
- **`FIELD / CHAIN`** 은 무조건 **PAI** 에서만 구현
- **`AT EXIT-COMMAND`** 은 무조건 **PAI** 에서만 구현
- **`AT EXIT-COMMAND`** 는 Screen 코드에서 **맨 위** 에 두는 게 좋음

</br>

---

</br>

## < PAI FIELD / CHAIN 입력 체크 방식 >
- **`FIELD / CHAIN`** 은 무조건 **PAI** 에서만 구현
- 화면에 입력된 값을 기준으로 검증하기 위해 사용
</br>

### 1) 기본형 (옵션 없음) – 항상 실행
- PAI 발생 시 무조건 MODULE 실행
- 값 입력 여부, 변경 여부 모두 무관
</br>

- **단일값 체크 (FIELD)**
```abap
FIELD <field> MODULE <module>.
```
```abap
FIELD SCARR-CARRID MODULE CHECK_INPUT.
```
- **다중값 체크 (CHAIN)**
```abap
CHAIN.
  FIELD: <field1>, <field2>.
  MODULE <module>.
ENDCHAIN.
```
```abap
CHAIN.
  FIELD: SDYN_CONN-CARRID, SDYN_CONN-CONNID.
  MODULE CHECK_INPUTS.
ENDCHAIN.
```
</br>
</br>

### 2) 입력값 존재 기준 (ON INPUT / ON CHAIN-INPUT)
- 값이 입력된 경우에만 MODULE 실행
- 다중 값 체크 시 CHAIN 내 하나라도 값이 있으면 실행 (OR 조건)
</br>

- **단일값 체크 (ON INPUT)**
```abap
FIELD <field> MODULE <module> ON INPUT.
```
```abap
FIELD SCARR-CARRID MODULE CHECK_INPUT ON INPUT.
```
- **다중값 체크 (ON CHAIN-INPUT)**
```abap
CHAIN.
  FIELD: <field1>, <field2>.
  MODULE <module> ON CHAIN-INPUT.
ENDCHAIN.
```
```abap
CHAIN.
  FIELD: SDYN_CONN-CARRID, SDYN_CONN-CONNID.
  MODULE CHECK_INPUTS ON CHAIN-INPUT.
ENDCHAIN.
```
</br>
</br>

### 3) 값 변경 기준 (ON REQUEST / ON CHAIN-REQUEST)
- 이전 값과 비교하여 변경되었을 때만 MODULE 실행
- 다중 값 체크 시 CHAIN 내 하나라도 값이 변경되면 실행
- 값의 존재 여부와 무관하게, 이전 값과 달라지기만 하면 실행 ( 값이 있다가 빈 값이어도 실행 )
</br>

- **단일값 체크 (ON REQUEST)**
```abap
FIELD <field> MODULE <module> ON REQUEST.
```
```abap
FIELD SCARR-CARRID MODULE CHECK_INPUT ON REQUEST.
```
- **다중값 체크 (ON CHAIN-REQUEST)**
```abap
CHAIN.
  FIELD: <field1>, <field2>.
  MODULE <module> ON CHAIN-REQUEST.
ENDCHAIN.
```
```abap
CHAIN.
  FIELD: SDYN_CONN-CARRID, SDYN_CONN-CONNID.
  MODULE CHECK_INPUTS ON CHAIN-REQUEST.
ENDCHAIN.
```
</br>
</br>
</br>

## < PAI FIELD / CHAIN 예제 >
</br>

**1) `Layout` 설정**

<img width="538" height="255" alt="image" src="https://github.com/user-attachments/assets/f839bae4-e194-4514-b412-e8e6838c230b" />

</br>
</br>

**2) `Screen` 코드에서 모듈 생성 ( PAI, PBO )**
```abap
PROCESS BEFORE OUTPUT.
 MODULE STATUS_0100.
 MODULE INIT_DATA.
*
PROCESS AFTER INPUT.
  MODULE EXIT AT EXIT-COMMAND.

**********************************************************************

* FIELD SCARR-CARRID MODULE CHECK_INPUT. " 단일값 체크
*
* CHAIN. " 다중값 체크
*  FIELD: SDYN_CONN-CARRID, SDYN_CONN-CONNID.
*  MODULE CHECK_INPUTS.
* ENDCHAIN.

**********************************************************************

*  " 단일값 체크 : ON INPUT 값이 있을때만 체크하도록 설정
*  FIELD SCARR-CARRID MODULE CHECK_INPUT ON INPUT.
*
*  " 다중값 체크 : ON CHAIN-INPUT 값이 있을때만 체크하도록 설정
*  CHAIN.
*    FIELD: SDYN_CONN-CARRID, SDYN_CONN-CONNID.
*    MODULE CHECK_INPUTS ON CHAIN-INPUT.
*  ENDCHAIN.
* MODULE USER_COMMAND_0100.

**********************************************************************

   " 단일값 체크 : ON REQUEST 값이 변경되었을 때 체크하도록 설정
  FIELD SCARR-CARRID MODULE CHECK_INPUT ON REQUEST.

  " 다중값 체크 : ON CHAIN-REQUEST 값이 변경되었을 때만 체크하도록 설정
  CHAIN.
    FIELD: SDYN_CONN-CARRID, SDYN_CONN-CONNID.
    MODULE CHECK_INPUTS ON CHAIN-REQUEST.
  ENDCHAIN.
 MODULE USER_COMMAND_0100.
```
</br>

**3) `PAI` 에서 모듈 생성**
```abap
" 단일입력
MODULE check_input INPUT.
  IF SCARR-CARRID IS NOT INITIAL.
    SELECT SINGLE CARRID
      FROM SPFLI " 여기엔 AB값이 없음
      INTO SCARR-CARRID
      WHERE CARRID = SCARR-CARRID.
    IF sy-subrc <> 0.
      MESSAGE '해당 항공사 데이터는 존재하지 않습니다.' TYPE 'E'.
    ENDIF.
  ENDIF.
ENDMODULE.

" 다중입력
MODULE check_inputs INPUT.
  IF SDYN_CONN-CARRID IS NOT INITIAL AND
     SDYN_CONN-CONNID IS NOT INITIAL.
    SELECT SINGLE *
      FROM SPFLI
      INTO CORRESPONDING FIELDS OF SDYN_CONN
      WHERE CARRID = SDYN_CONN-CARRID
        AND CONNID = SDYN_CONN-CONNID.
    IF sy-subrc <> 0.
      MESSAGE '해당 항공사의 항공편이 존재하지 않습니다.' TYPE 'E'.
    ENDIF.
  ENDIF.
ENDMODULE.
```

</br>
</br>
</br>

---

</br>

## < AT EXIT-COMMAND >
- **`AT EXIT-COMMAND`** 은 무조건 **PAI** 에서만 구현
- `AT EXIT-COMMAND` 는 Screen 코드에서 맨 위에 두는 게 좋음
- PF-STATUS에서 Function Type = E(Exit) 로 정의된 커맨드만 대상으로 동작함
- 메시지 E로 화면 진행이 막힌 상태에서, 사용자가 “종료”를 선택했을 때 빠져나가기 위한 용도
</br>
</br>

**1) `Function Type` 설정**
- `EXIT` , `CANCEL` 일 때 `Function Type` 을 `E` 로 설정

<img width="669" height="331" alt="image" src="https://github.com/user-attachments/assets/b0aae6c7-d74c-49c6-887c-1824e4d1c110" />

</br>
</br>
</br>
</br>

**2) `PAI` 모듈 생성**
- Screen 코드에서 모듈 생성
```abap
PROCESS AFTER INPUT.
  MODULE <module_name> AT EXIT-COMMAND.
```
```abap
PROCESS AFTER INPUT.
  MODULE EXIT AT EXIT-COMMAND.
```
- 해당 PAI 모듈에서 코드 작성
```abap
MODULE exit INPUT.
  CASE OK_CODE.
    WHEN 'EXIT'.
      LEAVE PROGRAM. " 프로그램 종료
    WHEN 'CANCEL'.
      LEAVE TO SCREEN 0. " 스크린 종료
    WHEN OTHERS.
  ENDCASE.
ENDMODULE.
```
</br>
</br>

**3) 결과 확인**
- `EXIT` , `CANCEL` 누르면 에러가 나도 빠져나올 수 있음 ( `BACK` 은 불가능 )

<img width="580" height="383" alt="image" src="https://github.com/user-attachments/assets/5c8e4e7b-c752-4f23-b7d2-928950bfda70" />
</br>
</br>
</br>
</br>

---

</br>

## < 종료(Function) 버튼 로직 >
- **🟢 Back (뒤로가기)**

  - 일반적인 화면 이동용 버튼
  - 이전 화면으로 돌아가며 프로그램은 종료되지 않음
- **🟡 Exit (노란색)**

  - 현재 프로그램을 완전히 종료
  - SAP Easy Access(초기 화면)로 이동
- **🔴 Cancel (빨간색)**
  
  - 오류 발생 등으로 진행이 불가능할 때 사용
  - 현재 처리를 취소하고 이전 상태로 복귀

<img width="550" height="377" alt="image" src="https://github.com/user-attachments/assets/1b0e6a46-aec0-4a37-b379-d4190f733c21" />
</br>
</br>
</br>
</br>
</br>

### < `Back` 예제 >
</br>

**1) `TOP` 모듈 생성**
```abap
PROGRAM SAPMZB03005.

" TABLES에는 직접적으로 Table 이름 넣는것보단
" 필요한 필드 구성하여 만든 Structure 이름 넣는게 좋음.
" => 지금은 테스트용으로..
TABLES: SCARR, SDYN_CONN.
DATA: OK_CODE TYPE sy-ucomm.

" 신호등 결과 값으로 '1', '2', 'A' 를 받을 변수
DATA: gv_answer TYPE C.
```
</br>

**2) `PAI` 모듈 생성**
```abap
MODULE user_command_0100 INPUT.
  CASE OK_CODE.
    WHEN 'BACK'.
      CALL FUNCTION 'POPUP_TO_CONFIRM'
        EXPORTING
          titlebar =  'Information'
          text_question               = 'Are you sure?'
        IMPORTING
          ANSWER                      = gv_answer
        EXCEPTIONS
          TEXT_NOT_FOUND              = 1
          OTHERS                      = 2.

      IF sy-subrc <> 0.
        MESSAGE '오류 발생' TYPE 'E'.
      ELSE.
        IF gv_answer = 1.
          LEAVE TO SCREEN 0.
        ENDIF.
      ENDIF.
    WHEN OTHERS.
  ENDCASE.
ENDMODULE.
```
</br>

**3) 결과 확인**
- `BACK` 누르면 팝업이 뜸

<img width="611" height="294" alt="image" src="https://github.com/user-attachments/assets/c1948e66-7c1b-4390-a450-c088b3697217" />
</br>
</br>
</br>
</br>
</br>

---

</br>

## < 추가적인 기능 >

</br>

- **`PAI` 에 있는 모듈들은 순차적으로 실행됨**
<img width="525" height="363" alt="image" src="https://github.com/user-attachments/assets/fb5f10f3-4de3-41cc-884e-4ea875403676" />
</br>
</br>
</br>
</br>

### `SWITCH` ( TCODE : `SFW5` ) 기반 MODULE 호출
- SWITCH는 스위치가 ON일 때만 MODULE을 실행하는 제어 장치
- PAI에서 조건부로 로직을 활성/비활성하기 위해 사용
```abap
PROCESS AFTER INPUT.
  MODULE <module_name> SWITCH <switch_name>.
```
```abap
PROCESS AFTER INPUT.
  MODULE add_check SWITCH sw_bc410.
```
- `PAI` 모듈 코드
```abap
MODULE add_check INPUT.
  CASE ok_code.
    WHEN 'ADD_FUNCTION'.
      " 기능 처리
  ENDCASE.
ENDMODULE.
```
</br>
</br>

### `SET / GET PARAMETER`
- 서로 다른 프로그램/화면 간에 입력값을 공유하기 위한 기능
- Data Element에 설정된 Parameter ID를 키로 사용
- 한 프로그램에서 SET으로 저장한 값을 다른 프로그램에서 GET으로 불러옴

<img width="433" height="330" alt="image" src="https://github.com/user-attachments/assets/2092cfa6-8af8-403b-b2e8-4b55492a8c7d" />
</br>
</br>
</br>
</br>

---

</br>

## < 실습 코드 >
</br>

### 실습 1
</br>

- 문제
  
<img width="445" height="225" alt="image" src="https://github.com/user-attachments/assets/64038eae-eb24-46ab-9a1f-a283a997be7c" />
</br>
</br>
</br>

**1) `Layout` 설정**

<img width="282" height="256" alt="image" src="https://github.com/user-attachments/assets/752bef5c-f436-4598-8335-657595f20b67" />
</br>
</br>

**2) `Screen` 코드에서 모듈 생성 ( PAI, PBO )**
```abap
PROCESS BEFORE OUTPUT.
 MODULE STATUS_0100.
 MODULE CLEAR_OK_CODE.
*
PROCESS AFTER INPUT.
 MODULE EXIT AT EXIT-COMMAND.
 CHAIN.
  FIELD: SDYN_BOOK-CARRID, SDYN_BOOK-CONNID, SDYN_BOOK-FLDATE,
SDYN_BOOK-BOOKID.
  MODULE CHECK_INPUTS ON CHAIN-REQUEST.
 ENDCHAIN.
 MODULE USER_COMMAND_0100.
```
</br>


**3) `TOP` 모듈 생성**
```abap
PROCESS BEFORE OUTPUT.
 MODULE STATUS_0100.
 MODULE CLEAR_OK_CODE.
*
PROCESS AFTER INPUT.
 MODULE EXIT AT EXIT-COMMAND.
 CHAIN.
  FIELD: SDYN_BOOK-CARRID, SDYN_BOOK-CONNID, SDYN_BOOK-FLDATE, SDYN_BOOK-BOOKID.
  MODULE CHECK_INPUTS ON CHAIN-REQUEST.
 ENDCHAIN.
 MODULE USER_COMMAND_0100.
```
</br>

**4) `PAI` 모듈 생성**
```abap
MODULE check_inputs INPUT.
  IF SDYN_BOOK-CARRID IS NOT INITIAL AND
     SDYN_BOOK-CONNID IS NOT INITIAL AND
     SDYN_BOOK-FLDATE IS NOT INITIAL AND
     SDYN_BOOK-BOOKID IS NOT INITIAL.
    SELECT SINGLE CANCELLED FROM SBOOK
      INTO gv_cancelled
      WHERE carrid = SDYN_BOOK-CARRID
        AND connid = SDYN_BOOK-CONNID
        AND fldate = SDYN_BOOK-FLDATE
        AND bookid = SDYN_BOOK-BOOKID.
    SELECT SINGLE carrid connid fldate bookid CUSTOMID CUSTTYPE FROM SBOOK
      INTO CORRESPONDING FIELDS OF gs_data
      WHERE carrid = SDYN_BOOK-CARRID
        AND connid = SDYN_BOOK-CONNID
        AND fldate = SDYN_BOOK-FLDATE
        AND bookid = SDYN_BOOK-BOOKID.

    IF gv_cancelled = 'X'.
      MESSAGE '항공편 예약이 취소된 건 입니다.' TYPE 'E'.
    ENDIF.
  ENDIF.
ENDMODULE.

*----------------------------------------------------------------------*

MODULE user_command_0100 INPUT.
  CASE OK_CODE.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN OTHERS.
  ENDCASE.
ENDMODULE.

*----------------------------------------------------------------------*

MODULE EXIT INPUT.
  CASE OK_CODE.
    WHEN 'EXIT'.
      LEAVE PROGRAM.
    WHEN 'CANCEL'.
      LEAVE TO SCREEN 0.
    WHEN OTHERS.
  ENDCASE.
ENDMODULE.
```
</br>

**5) `PBO` 모듈 생성**

<img width="536" height="186" alt="image" src="https://github.com/user-attachments/assets/d8623302-5ef3-45b0-b053-ce9d166d5cc1" />
</br>
</br>

```abap
MODULE status_0100 OUTPUT.
  SET PF-STATUS 'S100'.
  MOVE-CORRESPONDING gs_data TO SDYN_BOOK.
ENDMODULE.

*&---------------------------------------------------------------------*

MODULE clear_ok_code OUTPUT.
  CLEAR: OK_CODE.
ENDMODULE.
```
</br>

**6) 결과 확인**
- CANCELLED 가 `X` 일 때

<img width="289" height="258" alt="image" src="https://github.com/user-attachments/assets/ad495b9a-3564-4de0-80be-5a8bed2ddd53" />
</br>
</br>

- CANCELLED 가 `X` 가 아닐 때

<img width="280" height="257" alt="image" src="https://github.com/user-attachments/assets/f31a0317-f737-4867-8f4d-b54428c2f1e5" />
</br>
</br>
